<?xml version="1.0" encoding="UTF-8" ?>
<!--
 ____        _ _    ___  ____
/ ___|  __ _| | |_ / _ \/ ___|
\___ \ / _` | | __| | | \___ \
 ___) | (_| | | |_| |_| |___) |
|____/ \__,_|_|\__|\___/|____/

SaltOS: Framework to develop Rich Internet Applications
Copyright (C) 2013 by Josep Sanz CampderrÃ³s
More information in http://www.saltos.net or info@saltos.net

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<root>
	<list>
		<title lang="true">list</title>
		<actions include="xml/common/actions.xml" replace="true"/>
		<width>100%</width>
		<fields>
			<field>
				<name>id2</name>
				<label lang="true">id</label>
				<sort>true</sort>
				<order>id</order>
			</field>
			<field>
				<name>empresa</name>
				<label lang="true">empresa</label>
				<sort>true</sort>
				<size>20</size>
				<order>empresa2</order>
			</field>
			<field>
				<name>fecha</name>
				<label lang="true">date</label>
				<sort>true</sort>
			</field>
			<field>
				<name>base</name>
				<label eval="true">LANG("base")." (".CONFIG("accounting_currency").")"</label>
				<sort>true</sort>
				<math>
					<func>sum()</func>
					<label eval="true">LANG("suma")." (".CONFIG("accounting_currency").")"</label>
				</math>
			</field>
			<field>
				<name>total</name>
				<label eval="true">LANG("total")." (".CONFIG("accounting_currency").")"</label>
				<sort>true</sort>
				<math>
					<func>sum()</func>
					<label eval="true">LANG("suma")." (".CONFIG("accounting_currency").")"</label>
				</math>
			</field>
			<field>
				<name>liquidado</name>
				<label lang="true">liq</label>
				<sort>false</sort>
				<class>estado</class>
			</field>
			<field>
				<name>fecha2</name>
				<label lang="true">dateliq</label>
				<sort>true</sort>
			</field>
			<field>
				<name>vencimientos</name>
				<label lang="true">numv</label>
				<tip lang="true">numvtip</tip>
				<sort>false</sort>
			</field>
			<field>
				<name>cuenta</name>
				<label lang="true">cuenta</label>
				<sort>false</sort>
			</field>
		</fields>
		<javascript>
			<javascript include="xml/common/jslist.xml" replace="true" />
			<function eval="true">"liquidar1() { var id=getIds(); if(!id) return; dialog(\"".LANG_ESCAPE("confirm")."\",\"".LANG_ESCAPE("msgliquidar")."\",{'".LANG_ESCAPE("yes")."':function() { dialog('close'); setParam('action','liquidar'); setParam('id',id); submit1(); },'".LANG_ESCAPE("no")."':function() { dialog('close'); } }); }"</function>
			<cache>
				<include>js/updateproyectos.js</include>
			</cache>
		</javascript>
		<quick>
			<row>
				<field>
					<type>separator</type>
					<width>100%</width>
				</field>
				<field ifeval="check_filter(array('id_pagador'=>'','liquidado'=>'','id_formapago'=>'','fecha1'=>'', 'fecha2'=>'','trimestre'=>'', 'id_cliente'=>'','fecha1reg'=>'','fecha2reg'=>'','trimestrereg'=>'','id_proyecto'=>'','fecha1liq'=>'','fecha2liq'=>'','trimestreliq'=>'', 'id_proveedor'=>'','filtro'=>'','id_cuenta'=>''))">
					<type>label</type>
					<label lang="true">usedfilter</label>
					<class>nowrap</class>
					<class2>info</class2>
				</field>
				<field>
					<name>buscar</name>
					<label lang="true">buscar</label>
					<type>text</type>
					<width>240px</width>
					<value global="filtro" eval="true">stripslashes($filtro=getParam("filtro"))</value>
					<onchange>copy_value("filtro","buscar");</onchange>
					<onkeypress>if(is_enterkey(event)) { copy_value("filtro","buscar");buscar(); }</onkeypress>
					<focus>true</focus>
					<speech>true</speech>
					<class3>shortcut_ctrl_f</class3>
				</field>
				<field>
					<type>button</type>
					<value lang="true">buscar</value>
					<tip lang="true">buscartip</tip>
					<onclick>buscar()</onclick>
					<icon>find</icon>
					<class>nowrap</class>
				</field>
				<field>
					<type>button</type>
					<value lang="true">excel</value>
					<tip lang="true">exceltip</tip>
					<onclick>excel()</onclick>
					<icon>excel</icon>
					<class>nowrap contextmenu</class>
				</field>
				<field>
					<type>button</type>
					<class>nowrap</class>
					<value lang="true">liquidar</value>
					<onclick>liquidar1()</onclick>
					<width>1px</width>
					<icon>download</icon>
					<class>nowrap contextmenu</class>
				</field>
				<field>
					<type>button</type>
					<value lang="true">limpiar</value>
					<tip lang="true">limpiartip</tip>
					<onclick>limpiar()</onclick>
					<icon>refresh</icon>
					<class>nowrap contextmenu</class>
				</field>
			</row>
		</quick>
		<form>
			<name>list</name>
			<action>xml.php</action>
			<method>get</method>
			<fields>
				<title lang="true">filter</title>
				<buttons>true</buttons>
				<row>
					<field include="xml/common/hiddenslist.xml" replace="true" />
					<node path="field[name=order]/value" replace="true">
						<value global="order" eval="true">$order=getParam("order","action_id desc")</value>
					</node>
					<field>
						<name>id_pagador</name>
						<label lang="true">pagadopor</label>
						<type>select</type>
						<width>240px</width>
						<query eval="true">make_select_query("usuarios","tbl_usuarios",array(make_extra_query_with_login(),"id_aplicacion,id_registro,login"),"SELECT id FROM tbl_usuarios WHERE activo=1")." UNION SELECT '' `value`,'".LANG_ESCAPE("mostrartodos")."' label,-1 pos UNION SELECT '0' `value`,'".LANG_ESCAPE("sinusuario")."' label,'-1' pos ORDER BY `pos` ASC,`label` ASC,`value` ASC"</query>
						<value global="id_pagador" eval="true">$id_pagador=getParam("id_pagador")</value>
						<colspan>4</colspan>
					</field>
					<field>
						<name>liquidado</name>
						<label lang="true">liquidado</label>
						<type>select</type>
						<width>90px</width>
						<query eval="true">"SELECT '1' `value`,'".LANG_ESCAPE("yes")."' label UNION SELECT '0' `value`,'".LANG_ESCAPE("no")."' label UNION SELECT '' `value`,'".LANG_ESCAPE("todos")."' label ORDER BY label"</query>
						<value global="liquidado" eval="true">$liquidado=getParam("liquidado")</value>
						<colspan>2</colspan>
					</field>
					<field>
						<name>id_formapago</name>
						<label lang="true">formapago</label>
						<type>select</type>
						<width>240px</width>
						<query eval="true">make_select_query("formaspago","tbl_formaspago","nombre")." UNION SELECT '0' value,'".LANG_ESCAPE("sinformapago")."' label,'-1' pos UNION SELECT '' value,'".LANG_ESCAPE("todaslasformasdepago")."' label,'-1' pos ORDER BY `pos` ASC,`label` ASC,`value` ASC"</query>
						<value global="id_formapago" eval="true">$id_formapago=getParam("id_formapago")</value>
						<colspan>4</colspan>
					</field>
				</row>
				<row>
					<field>
						<name>fecha1</name>
						<label lang="true">fechaini</label>
						<type>date</type>
						<width>90px</width>
						<value global="fecha1" eval="true">$fecha1=getParam("fecha1")?dateval(getParam("fecha1")):""</value>
						<icon>calendar</icon>
						<onchange>check_date("fecha1","le","fecha2")</onchange>
					</field>
					<field>
						<name>fecha2</name>
						<label lang="true">fechafin</label>
						<type>date</type>
						<width>90px</width>
						<value global="fecha2" eval="true">$fecha2=getParam("fecha2")?dateval(getParam("fecha2")):""</value>
						<class2>right</class2>
						<icon>calendar</icon>
						<onchange>check_date("fecha2","ge","fecha1")</onchange>
					</field>
					<field>
						<type>separator</type>
						<width>10px</width>
					</field>
					<field>
						<name>trimestre</name>
						<label lang="true">trimestre</label>
						<type>select</type>
						<width>90px</width>
						<query eval="true">"SELECT DISTINCT
						YEAR(fecha)*4+TRUNCATE((MONTH(fecha)-1)/3,0) `value`,CONCAT(YEAR(fecha),' (',TRUNCATE((MONTH(fecha)-1)/3,0)+1,')') label from tbl_gastos UNION SELECT '' `value`,'".LANG_ESCAPE("todos")."' label ORDER BY `value` DESC"</query>
						<value global="trimestre" eval="true">$trimestre=getParam("trimestre")</value>
					</field>
					<field>
						<type>separator</type>
						<width>10px</width>
					</field>
					<field>
						<name>id_cliente</name>
						<label lang="true">cliente</label>
						<type>select</type>
						<width>240px</width>
						<query eval="true">make_select_query("clientes","tbl_clientes","nombre","SELECT id_cliente FROM tbl_gastos")." UNION SELECT '0' `value`,'".LANG_ESCAPE("sincliente")."' label,-1 pos UNION SELECT '' `value`,'".LANG_ESCAPE("todoslosclientes")."' label,-1 pos ORDER BY `pos` ASC,`label` ASC,`value` ASC"</query>
						<value global="id_cliente" eval="true">$id_cliente=getParam("id_cliente")</value>
						<colspan>4</colspan>
						<onchange>update_proyectos()</onchange>
					</field>
				</row>
				<row>
					<field>
						<name>fecha1reg</name>
						<label lang="true">fechainireg</label>
						<type>date</type>
						<width>90px</width>
						<value global="fecha1reg" eval="true">$fecha1reg=getParam("fecha1reg")?dateval(getParam("fecha1reg")):""</value>
						<icon>calendar</icon>
						<onchange>check_date("fecha1reg","le","fecha2reg")</onchange>
					</field>
					<field>
						<name>fecha2reg</name>
						<label lang="true">fechafin</label>
						<type>date</type>
						<width>90px</width>
						<value global="fecha2reg" eval="true">$fecha2reg=getParam("fecha2reg")?dateval(getParam("fecha2reg")):""</value>
						<class2>right</class2>
						<icon>calendar</icon>
						<onchange>check_date("fecha2reg","ge","fecha1reg")</onchange>
					</field>
					<field>
						<type>separator</type>
						<width>10px</width>
					</field>
					<field>
						<name>trimestrereg</name>
						<label lang="true">trimestrereg</label>
						<type>select</type>
						<width>90px</width>
						<query global="page" eval="true">"SELECT DISTINCT YEAR(`datetime`)*4+TRUNCATE((MONTH(`datetime`)-1)/3,0) `value`,CONCAT(YEAR(`datetime`),' (',TRUNCATE((MONTH(`datetime`)-1)/3,0)+1,')') label from tbl_gastos a LEFT JOIN tbl_registros_i b ON b.id_aplicacion='".page2id($page)."' AND b.id_registro=a.id UNION SELECT '' `value`,'".LANG_ESCAPE("todos")."' label ORDER BY `value` DESC"</query>
						<value global="trimestrereg" eval="true">$trimestrereg=getParam("trimestrereg")</value>
					</field>
					<field>
						<type>separator</type>
						<width>10px</width>
					</field>
					<field>
						<name>id_proyecto</name>
						<label lang="true">proyecto</label>
						<type>select</type>
						<width>240px</width>
						<query eval="true">"SELECT '' `value`,'".LANG_ESCAPE("todoslosproyectos")."' label UNION SELECT '0' `value`,'".LANG_ESCAPE("sinproyecto")."' label"</query>
						<value global="id_proyecto" eval="true">$id_proyecto=getParam("id_proyecto")</value>
						<colspan>4</colspan>
					</field>
				</row>
				<row>
					<field>
						<name>fecha1liq</name>
						<label lang="true">fechainiliq</label>
						<type>date</type>
						<width>90px</width>
						<value global="fecha1liq" eval="true">$fecha1liq=getParam("fecha1liq")?dateval(getParam("fecha1liq")):""</value>
						<icon>calendar</icon>
						<onchange>check_date("fecha1liq","le","fecha2liq")</onchange>
					</field>
					<field>
						<name>fecha2liq</name>
						<label lang="true">fechafin</label>
						<type>date</type>
						<width>90px</width>
						<value global="fecha2liq" eval="true">$fecha2liq=getParam("fecha2liq")?dateval(getParam("fecha2liq")):""</value>
						<class2>right</class2>
						<icon>calendar</icon>
						<onchange>check_date("fecha2liq","ge","fecha1liq")</onchange>
					</field>
					<field>
						<type>separator</type>
						<width>10px</width>
					</field>
					<field>
						<name>trimestreliq</name>
						<label lang="true">trimestreliq</label>
						<type>select</type>
						<width>90px</width>
						<query global="page" eval="true">"SELECT DISTINCT YEAR(`datetime`)*4+TRUNCATE((MONTH(`datetime`)-1)/3,0) `value`,CONCAT(YEAR(`datetime`),' (',TRUNCATE((MONTH(`datetime`)-1)/3,0)+1,')') label from tbl_gastos a LEFT JOIN tbl_registros_i b ON b.id_aplicacion='".page2id($page)."' AND b.id_registro=a.id UNION SELECT '' `value`,'".LANG_ESCAPE("todos")."' label ORDER BY `value` DESC"</query>
						<value global="trimestreliq" eval="true">$trimestreliq=getParam("trimestreliq")</value>
					</field>
					<field>
						<type>separator</type>
						<width>10px</width>
					</field>
					<field>
						<name>id_proveedor</name>
						<label lang="true">proveedor</label>
						<type>select</type>
						<width>240px</width>
						<query eval="true">make_select_query("proveedores","tbl_proveedores","nombre","SELECT id_proveedor FROM tbl_gastos")." UNION SELECT '' value,'".LANG_ESCAPE("todoslosproveedores")."' label,'-1' pos UNION SELECT '0' value,'".LANG_ESCAPE("sinproveedor")."' label,'-1' pos ORDER BY `pos` ASC,`label` ASC,`value` ASC"</query>
						<value global="id_proveedor" eval="true">$id_proveedor=getParam("id_proveedor")</value>
						<colspan>4</colspan>
					</field>
				</row>
				<row>
					<field>
						<name>filtro</name>
						<label lang="true">otroscampos</label>
						<type>text</type>
						<width>240px</width>
						<value global="filtro" eval="true">stripslashes($filtro=getParam("filtro"))</value>
						<colspan>4</colspan>
						<onchange>copy_value("buscar","filtro");</onchange>
						<speech>true</speech>
					</field>
					<field>
						<name>id_cuenta</name>
						<label lang="true">cuenta</label>
						<type>select</type>
						<width>90px</width>
						<query eval="true">make_select_query("cuentas","tbl_cuentas","nombre")." UNION SELECT '0' value,'".LANG_ESCAPE("sincuenta")."' label,'-1' pos UNION SELECT '' value,'".LANG_ESCAPE("todaslascuentas")."' label,'-1' pos ORDER BY `pos` ASC,`label` ASC,`value` ASC"</query>
						<value global="id_cuenta" eval="true">$id_cuenta=getParam("id_cuenta")</value>
						<colspan>4</colspan>
					</field>
				</row>
			</fields>
			<fields include="xml/common/filters.xml" replace="true" />
			<fields>
				<title lang="true">graficas</title>
				<row>
					<field>
						<type>plot</type>
						<width eval="true">CONFIG("plot_list_width")."px"</width>
						<height eval="true">CONFIG("plot_list_height")."px"</height>
						<vars>1</vars>
						<graph>bars</graph>
						<title lang="true">plotseguimiento12meses</title>
						<query>SELECT CONCAT(SUBSTR((((xx-1)-(xx-1)%12)/12),1,4),'-',SUBSTR(((xx-1)%12+101),2,2)) y0,CASE WHEN SUM(base) IS NULL THEN 0 ELSE SUM(base) END y1 FROM (SELECT MAX(SUBSTR(fecha,1,4)*12+SUBSTR(fecha,6,2))-0 xx FROM tbl_gastos UNION SELECT MAX(SUBSTR(fecha,1,4)*12+SUBSTR(fecha,6,2))-1 xx FROM tbl_gastos UNION SELECT MAX(SUBSTR(fecha,1,4)*12+SUBSTR(fecha,6,2))-2 xx FROM tbl_gastos UNION SELECT MAX(SUBSTR(fecha,1,4)*12+SUBSTR(fecha,6,2))-3 xx FROM tbl_gastos UNION SELECT MAX(SUBSTR(fecha,1,4)*12+SUBSTR(fecha,6,2))-4 xx FROM tbl_gastos UNION SELECT MAX(SUBSTR(fecha,1,4)*12+SUBSTR(fecha,6,2))-5 xx FROM tbl_gastos UNION SELECT MAX(SUBSTR(fecha,1,4)*12+SUBSTR(fecha,6,2))-6 xx FROM tbl_gastos UNION SELECT MAX(SUBSTR(fecha,1,4)*12+SUBSTR(fecha,6,2))-7 xx FROM tbl_gastos UNION SELECT MAX(SUBSTR(fecha,1,4)*12+SUBSTR(fecha,6,2))-8 xx FROM tbl_gastos UNION SELECT MAX(SUBSTR(fecha,1,4)*12+SUBSTR(fecha,6,2))-9 xx FROM tbl_gastos UNION SELECT MAX(SUBSTR(fecha,1,4)*12+SUBSTR(fecha,6,2))-10 xx FROM tbl_gastos UNION SELECT MAX(SUBSTR(fecha,1,4)*12+SUBSTR(fecha,6,2))-11 xx FROM tbl_gastos UNION SELECT MAX(SUBSTR(fecha,1,4)*12+SUBSTR(fecha,6,2))-12 xx FROM tbl_gastos) a LEFT JOIN tbl_gastos b ON xx=SUBSTR(fecha,1,4)*12+SUBSTR(fecha,6,2) GROUP BY xx ORDER BY xx ASC</query>
					</field>
					<field>
						<type>plot</type>
						<width eval="true">CONFIG("plot_list_width")."px"</width>
						<height eval="true">CONFIG("plot_list_height")."px"</height>
						<vars>1</vars>
						<graph>pie</graph>
						<title lang="true">plotseguimiento12meses</title>
						<query>SELECT CONCAT(SUBSTR((((xx-1)-(xx-1)%12)/12),1,4),'-',SUBSTR(((xx-1)%12+101),2,2)) y0,CASE WHEN SUM(base) IS NULL THEN 0 ELSE SUM(base) END y1 FROM (SELECT MAX(SUBSTR(fecha,1,4)*12+SUBSTR(fecha,6,2))-0 xx FROM tbl_gastos UNION SELECT MAX(SUBSTR(fecha,1,4)*12+SUBSTR(fecha,6,2))-1 xx FROM tbl_gastos UNION SELECT MAX(SUBSTR(fecha,1,4)*12+SUBSTR(fecha,6,2))-2 xx FROM tbl_gastos UNION SELECT MAX(SUBSTR(fecha,1,4)*12+SUBSTR(fecha,6,2))-3 xx FROM tbl_gastos UNION SELECT MAX(SUBSTR(fecha,1,4)*12+SUBSTR(fecha,6,2))-4 xx FROM tbl_gastos UNION SELECT MAX(SUBSTR(fecha,1,4)*12+SUBSTR(fecha,6,2))-5 xx FROM tbl_gastos UNION SELECT MAX(SUBSTR(fecha,1,4)*12+SUBSTR(fecha,6,2))-6 xx FROM tbl_gastos UNION SELECT MAX(SUBSTR(fecha,1,4)*12+SUBSTR(fecha,6,2))-7 xx FROM tbl_gastos UNION SELECT MAX(SUBSTR(fecha,1,4)*12+SUBSTR(fecha,6,2))-8 xx FROM tbl_gastos UNION SELECT MAX(SUBSTR(fecha,1,4)*12+SUBSTR(fecha,6,2))-9 xx FROM tbl_gastos UNION SELECT MAX(SUBSTR(fecha,1,4)*12+SUBSTR(fecha,6,2))-10 xx FROM tbl_gastos UNION SELECT MAX(SUBSTR(fecha,1,4)*12+SUBSTR(fecha,6,2))-11 xx FROM tbl_gastos UNION SELECT MAX(SUBSTR(fecha,1,4)*12+SUBSTR(fecha,6,2))-12 xx FROM tbl_gastos) a LEFT JOIN tbl_gastos b ON xx=SUBSTR(fecha,1,4)*12+SUBSTR(fecha,6,2) GROUP BY xx ORDER BY xx ASC</query>
					</field>
				</row>
				<row>
					<field>
						<type>plot</type>
						<width eval="true">CONFIG("plot_list_width")."px"</width>
						<height eval="true">CONFIG("plot_list_height")."px"</height>
						<vars>1</vars>
						<graph>bars</graph>
						<title lang="true">plotseguimientotop10</title>
						<query eval="true">"SELECT CASE WHEN LENGTH(nombre)>10 THEN CONCAT(SUBSTR(nombre,1,10),'...') ELSE nombre END y0,SUM(base) y1 FROM tbl_gastos,tbl_proveedores WHERE tbl_gastos.id_proveedor=tbl_proveedores.id AND fecha>=DATE('".current_date(-86400*365)."') GROUP BY y0 ORDER BY y1 DESC LIMIT 10"</query>
					</field>
					<field>
						<type>plot</type>
						<width eval="true">CONFIG("plot_list_width")."px"</width>
						<height eval="true">CONFIG("plot_list_height")."px"</height>
						<vars>1</vars>
						<graph>pie</graph>
						<title lang="true">plotseguimientotop10</title>
						<query eval="true">"SELECT CASE WHEN LENGTH(nombre)>10 THEN CONCAT(SUBSTR(nombre,1,10),'...') ELSE nombre END y0,SUM(base) y1 FROM tbl_gastos,tbl_proveedores WHERE tbl_gastos.id_proveedor=tbl_proveedores.id AND fecha>=DATE('".current_date(-86400*365)."') GROUP BY y0 ORDER BY y1 DESC LIMIT 10"</query>
					</field>
				</row>
			</fields>
			<fields include="xml/common/helplist.xml" replace="true" />
			<buttons include="xml/common/buttonslist.xml" />
		</form>
		<pager include="xml/common/pagerlist.xml"/>
		<query global="page,id_cliente,fecha1,fecha2,fecha1reg,fecha2reg,fecha1liq,fecha2liq,trimestre,trimestrereg,trimestreliq,filtro,id_pagador,id_formapago,liquidado,id_proveedor,id_cuenta,id_proyecto" eval="true">"
		SELECT id2,id,
			usuario,`datetime`,empresa,empresa2,cif,fecha,base,iva,irpf,total,pagador,formapago,
			(CASE liquidado WHEN 1 THEN '".LANG_ESCAPE("yes")."' ELSE '".LANG_ESCAPE("no")."' END) liquidado,
			fecha2,
			(SELECT COUNT(*) FROM tbl_gastos_v v WHERE v.id_gasto=e.id) vencimientos,
			cuenta,
			id action_id,CONCAT(LPAD(id,5,0),' - ',descripcion) action_title,
			CASE
				WHEN (SELECT COUNT(*) FROM tbl_gastos_v v WHERE v.pagado=0 AND DATE('".current_date()."')>=v.fecha AND v.id_gasto=e.id)!=0 THEN 'style_pending'
				WHEN liquidado=0 THEN 'style_alarm'
				WHEN liquidado=1 THEN ''
			END action_style,
			CASE ".check_sql($page,"view")." WHEN 1 THEN 'true' ELSE 'false' END action_view,
			CASE ".check_sql($page,"edit")." WHEN 1 THEN 'true' ELSE 'false' END action_edit,
			CASE ".check_user($page,"create")." AND (".check_sql($page,"view")." OR ".check_sql($page,"edit").") WHEN 1 THEN 'true' ELSE 'false' END action_copy,
			CASE ".check_sql($page,"delete")." WHEN 1 THEN 'true' ELSE 'false' END action_delete
		FROM (
			SELECT a.*,
				CONCAT('link:gastos(',-a.id,'):',LPAD(a.id,5,0)) id2,
				CASE a.id_pagador WHEN '0' THEN '".LANG_ESCAPE("sinpagador")."' ELSE ".make_extra_query_with_login("b.")." END pagador,
				CASE a.id_proveedor WHEN '0' THEN '".LANG_ESCAPE("sinproveedor")."' ELSE
					CONCAT('link:proveedores(',-a.id_proveedor,'):',c.nombre) END empresa,
				CASE a.id_proveedor WHEN '0' THEN '".LANG_ESCAPE("sinproveedor")."' ELSE c.nombre END empresa2,
				c.cif cif,
				CASE id_formapago WHEN '0' THEN '".LANG_ESCAPE("sinformapago")."' ELSE d.nombre END formapago,
				f.id_usuario id_usuario,g.id_grupo id_grupo,f.`datetime` `datetime`,
				".make_extra_query_with_login("g.")." usuario,
				CASE a.id_cuenta WHEN '0' THEN '".LANG_ESCAPE("sincuenta")."' ELSE j.nombre END cuenta,
				(SELECT REPLACE(GROUP_CONCAT(search),',',' ') FROM tbl_ficheros WHERE id_aplicacion='".page2id($page)."' AND id_registro=a.id) search
			FROM tbl_gastos a
				LEFT JOIN tbl_cuentas j ON a.id_cuenta=j.id
				LEFT JOIN tbl_usuarios b ON a.id_pagador=b.id
				LEFT JOIN tbl_proveedores c ON a.id_proveedor=c.id
				LEFT JOIN tbl_formaspago d ON a.id_formapago=d.id
				LEFT JOIN tbl_registros_i f ON f.id_aplicacion='".page2id($page)."' AND f.id_registro=a.id
				LEFT JOIN tbl_usuarios g ON f.id_usuario=g.id
		) e
		WHERE ".make_like_query("id2,num,cif,empresa,descripcion,fecha,fecha2,datetime,search",$filtro)." AND ".($id_cliente?"(id_cliente='$id_cliente')":"(1=1)")." AND ".($id_proyecto?"(id_proyecto='$id_proyecto')":"(1=1)")." AND ".($fecha1?"(fecha>=DATE('$fecha1'))":"(1=1)")." AND ".($fecha2?"(DATE('$fecha2')>=fecha)":"(1=1)")." AND (''='$fecha1reg' OR DATE(`datetime`)>=DATE('$fecha1reg')) AND (''='$fecha2reg' OR DATE('$fecha2reg')>=DATE(`datetime`)) AND (''='$fecha1liq' OR fecha2>=DATE('$fecha1liq')) AND (''='$fecha2liq' OR DATE('$fecha2liq')>=fecha2) AND (''='$trimestre' OR '$trimestre'=YEAR(fecha)*4+TRUNCATE((MONTH(fecha)-1)/3,0)) AND (''='$trimestrereg' OR '$trimestrereg'=YEAR(`datetime`)*4+TRUNCATE((MONTH(`datetime`)-1)/3,0)) AND (''='$trimestreliq' OR '$trimestreliq'=YEAR(fecha2)*4+TRUNCATE((MONTH(fecha2)-1)/3,0)) AND (liquidado='$liquidado' OR ''='$liquidado') AND (id_pagador='$id_pagador' OR ''='$id_pagador') AND (id_formapago='$id_formapago' OR ''='$id_formapago') AND (id_proveedor='$id_proveedor' OR ''='$id_proveedor') AND (id_cuenta='$id_cuenta' OR ''='$id_cuenta') AND ".check_sql($page,"list")</query>
		<order global="order" eval="true">$order</order>
		<limit global="limit" eval="true">$limit</limit>
		<offset global="offset" eval="true">$offset</offset>
	</list>
	<form>
		<views>
			<view>
				<title lang="true">formview</title>
				<query>
					<query include="xml/common/qpermview.xml" replace="true" />
					<query include="xml/common/qdefaultview.xml" replace="true" />
					<files_old include="xml/common/qfilesold.xml" />
					<vencimientos_old>
						<vencimientos_old global="id" eval="true">"SELECT * FROM tbl_gastos_v WHERE id_gasto=".abs($id)</vencimientos_old>
					</vencimientos_old>
					<control include="xml/common/qcontrol.xml"/>
					<folders include="xml/common/qfolders.xml" />
					<help include="xml/common/qhelp.xml" replace="true" />
				</query>
			</view>
			<insert>
				<title lang="true">forminsert</title>
				<query>
					<query include="xml/common/qpermcreate.xml" replace="true" />
					<default eval="true">substr(getParam("id"),0,7)=="0_copy_"?"SELECT id_proyecto,'0' id,id_cliente,id_epigrafe,'".current_date()."' fecha,base,iva,irpf,total,id_pagador,id_formapago,'0' liquidado,id_proveedor,descripcion,'".current_date()."' fecha2,id_cuenta FROM tbl_gastos WHERE id='".substr(getParam("id"),7)."'":"SELECT '0' id,'0' id_cliente,'0' id_proyecto,'0' id_epigrafe,'".current_date()."' fecha,'0.00' base,'".CONFIG("accounting_iva_value")."' iva,'".CONFIG("accounting_irpf_value")."' irpf, '0.00' total,'".current_user()."' id_pagador,'0' id_formapago,'0' liquidado,'0' id_proveedor,'".current_date()."' fecha2,'0' id_cuenta"</default>
					<files_new include="xml/common/qfilesnew.xml" replace="true"/>
					<vencimientos_new>
						<vencimientos_new eval="true">substr(getParam("id"),0,7)=="0_copy_"?"
SELECT id,'".current_date()."' fecha,percent,importe FROM tbl_gastos_v WHERE id_gasto='".substr(getParam("id"),7)."' UNION
SELECT 'a' id,'' fecha,'0.00' percent,'0.00' importe UNION
SELECT 'b' id,'' fecha,'0.00' percent,'0.00' importe UNION
SELECT 'c' id,'' fecha,'0.00' percent,'0.00' importe UNION
SELECT 'd' id,'' fecha,'0.00' percent,'0.00' importe UNION
SELECT 'e' id,'' fecha,'0.00' percent,'0.00' importe":"
SELECT 'a' id,'' fecha,'0.00' percent,'0.00' importe UNION
SELECT 'b' id,'' fecha,'0.00' percent,'0.00' importe UNION
SELECT 'c' id,'' fecha,'0.00' percent,'0.00' importe UNION
SELECT 'd' id,'' fecha,'0.00' percent,'0.00' importe UNION
SELECT 'e' id,'' fecha,'0.00' percent,'0.00' importe UNION
SELECT 'f' id,'' fecha,'0.00' percent,'0.00' importe UNION
SELECT 'g' id,'' fecha,'0.00' percent,'0.00' importe UNION
SELECT 'h' id,'' fecha,'0.00' percent,'0.00' importe UNION
SELECT 'i' id,'' fecha,'0.00' percent,'0.00' importe UNION
SELECT 'j' id,'' fecha,'0.00' percent,'0.00' importe
						"</vencimientos_new>
					</vencimientos_new>
					<folders include="xml/common/qfolders.xml" />
					<help include="xml/common/qhelp.xml" replace="true" />
				</query>
			</insert>
			<update>
				<title lang="true">formupdate</title>
				<query>
					<query include="xml/common/qpermupdate.xml" replace="true" />
					<query include="xml/common/qdefaultview.xml" replace="true" />
					<files_old include="xml/common/qfilesold.xml" />
					<files_new include="xml/common/qfilesnew.xml" replace="true"/>
					<vencimientos_old>
						<vencimientos_old global="id" eval="true">"SELECT * FROM tbl_gastos_v WHERE id_gasto=".abs($id)</vencimientos_old>
					</vencimientos_old>
					<vencimientos_new>
						<vencimientos_new global="id" eval="true">"
SELECT 'a' id,'$id' id_gasto,'' fecha,'0.00' percent,'0.00' importe UNION
SELECT 'b' id,'$id' id_gasto,'' fecha,'0.00' percent,'0.00' importe UNION
SELECT 'c' id,'$id' id_gasto,'' fecha,'0.00' percent,'0.00' importe UNION
SELECT 'd' id,'$id' id_gasto,'' fecha,'0.00' percent,'0.00' importe UNION
SELECT 'e' id,'$id' id_gasto,'' fecha,'0.00' percent,'0.00' importe UNION
SELECT 'f' id,'$id' id_gasto,'' fecha,'0.00' percent,'0.00' importe UNION
SELECT 'g' id,'$id' id_gasto,'' fecha,'0.00' percent,'0.00' importe UNION
SELECT 'h' id,'$id' id_gasto,'' fecha,'0.00' percent,'0.00' importe UNION
SELECT 'i' id,'$id' id_gasto,'' fecha,'0.00' percent,'0.00' importe UNION
SELECT 'j' id,'$id' id_gasto,'' fecha,'0.00' percent,'0.00' importe
						"</vencimientos_new>
					</vencimientos_new>
					<control include="xml/common/qcontrol.xml"/>
					<folders include="xml/common/qfolders.xml" />
					<help include="xml/common/qhelp.xml" replace="true" />
				</query>
			</update>
		</views>
		<name>form</name>
		<action>xml.php</action>
		<method>post</method>
		<hiddens include="xml/common/hiddensform.xml" />
		<fields>
			<default>
				<fieldset>
					<title lang="true">defaultdata</title>
					<quick global="id" eval="true">$id>=0?"false":"true"</quick>
					<buttons>true</buttons>
					<row>
						<field>
							<name>id</name>
							<type>hidden</type>
						</field>
						<field>
							<name>id_cuenta</name>
							<label lang="true">cuenta</label>
							<type>select</type>
							<width>240px</width>
							<query eval="true">make_select_query("cuentas","tbl_cuentas","nombre")." UNION SELECT '0' value,'".LANG_ESCAPE("sincuenta")."' label,'-1' pos ORDER BY `pos` ASC,`label` ASC,`value` ASC"</query>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<colspan>4</colspan>
							<focus>true</focus>
							<link>clientes(-abs(ID))</link>
							<icon>view</icon>
							<required>true</required>
						</field>
						<field>
							<name>id_epigrafe</name>
							<label lang="true">epigrafe</label>
							<type>select</type>
							<width>240px</width>
							<query eval="true">"SELECT '0' `value`,'".LANG_ESCAPE("sinepigrafe")."' label UNION SELECT id `value`,CONCAT('(',codigo,') ',nombre) label FROM tbl_epigrafes ORDER BY label"</query>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<colspan>3</colspan>
							<required>true</required>
						</field>
					</row>
					<row>
						<field>
							<type>separator</type>
						</field>
					</row>
					<row>
						<field global="id" ifeval="$id&lt;0">
							<type>separator</type>
							<colspan>5</colspan>
						</field>
						<field global="id" ifeval="$id&gt;=0">
							<name>buscador</name>
							<label lang="true">buscador</label>
							<type>text</type>
							<width>240px</width>
							<colspan>4</colspan>
							<onchange>search_proveedor()</onchange>
							<speech>true</speech>
						</field>
						<field>
							<name>id_cliente</name>
							<label lang="true">cliente</label>
							<type>select</type>
							<width>240px</width>
							<query eval="true">make_select_query("clientes","tbl_clientes","nombre")." UNION SELECT '0' value,'".LANG_ESCAPE("sincliente")."' label,'-1' pos ORDER BY `pos` ASC,`label` ASC,`value` ASC"</query>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<onchange>update_proyectos()</onchange>
							<colspan>4</colspan>
							<link>clientes(-abs(ID))</link>
							<icon>view</icon>
						</field>
					</row>
					<row>
						<field>
							<name>id_proveedor</name>
							<label lang="true">proveedor</label>
							<type>select</type>
							<width>240px</width>
							<query eval="true">"SELECT '0' `value`,'".LANG_ESCAPE("sinproveedor")."' label"</query>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<colspan>4</colspan>
							<link>proveedores(-abs(ID))</link>
							<icon>view</icon>
						</field>
						<field>
							<name>id_proyecto</name>
							<label lang="true">proyecto</label>
							<type>select</type>
							<width>240px</width>
							<query eval="true">"SELECT '' `value`,'".LANG_ESCAPE("sinproyecto")."' label"</query>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<colspan>3</colspan>
							<link>proyectos(-abs(ID))</link>
							<icon>view</icon>
						</field>
					</row>
					<row>
						<field>
							<type>separator</type>
						</field>
					</row>
					<row>
						<field>
							<name>num</name>
							<label lang="true">numfac</label>
							<type>text</type>
							<width>120px</width>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<colspan>4</colspan>
						</field>
						<field>
							<name>fecha</name>
							<label lang="true">date</label>
							<type>date</type>
							<width>90px</width>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<colspan>3</colspan>
							<required>true</required>
							<icon>calendar</icon>
						</field>
					</row>
					<row>
						<field>
							<type>separator</type>
						</field>
					</row>
					<row>
						<field>
							<name>descripcion</name>
							<label lang="true">descripcion</label>
							<type>textarea</type>
							<width>600px</width>
							<height>120px</height>
							<colspan>8</colspan>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<required>true</required>
						</field>
					</row>
					<row>
						<field>
							<type>separator</type>
						</field>
					</row>
					<row>
						<field>
							<name>base</name>
							<label eval="true">LANG("base")." (".CONFIG("accounting_currency").")"</label>
							<type>float</type>
							<width>120px</width>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<onchange>update_totales_gasto()</onchange>
							<required>true</required>
						</field>
						<field>
							<type>label</type>
							<label lang="true">campoauto</label>
							<class>left</class>
						</field>
						<field>
							<type>separator</type>
							<colspan>2</colspan>
						</field>
						<field>
							<name>iva</name>
							<label eval="true">CONFIG("accounting_iva_name")." (%)"</label>
							<type>float</type>
							<width>120px</width>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<onchange>update_totales_gasto()</onchange>
							<colspan>2</colspan>
							<required>true</required>
						</field>
					</row>
					<row>
						<field>
							<name>total</name>
							<label eval="true">LANG("total")." (".CONFIG("accounting_currency").")"</label>
							<type>float</type>
							<width>120px</width>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<onchange>update_totales_gasto()</onchange>
							<colspan>4</colspan>
							<required>true</required>
						</field>
						<field>
							<name>irpf</name>
							<label eval="true">CONFIG("accounting_irpf_name")." (%)"</label>
							<type>float</type>
							<width>120px</width>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<onchange>update_totales_gasto()</onchange>
							<colspan>2</colspan>
							<required>true</required>
						</field>
					</row>
					<row>
						<field>
							<type>separator</type>
						</field>
					</row>
					<row>
						<field>
							<name>id_pagador</name>
							<label lang="true">pagadopor</label>
							<type>select</type>
							<width>240px</width>
							<query eval="true">make_select_query("usuarios","tbl_usuarios",array(make_extra_query_with_login(),"id_aplicacion,id_registro,login"),"SELECT id FROM tbl_usuarios WHERE activo=1")." UNION SELECT '0' `value`,'".LANG_ESCAPE("sinusuario")."' label,'-1' pos ORDER BY `pos` ASC,`label` ASC,`value` ASC"</query>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<colspan>4</colspan>
							<required>true</required>
						</field>
						<field>
							<name>liquidado</name>
							<label lang="true">liquidado</label>
							<type>checkbox</type>
							<value>1</value>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<colspan>2</colspan>
						</field>
					</row>
					<row>
						<field>
							<name>id_formapago</name>
							<label lang="true">formapago</label>
							<type>select</type>
							<width>240px</width>
							<query eval="true">make_select_query("formaspago","tbl_formaspago","nombre")." UNION SELECT '0' value,'".LANG_ESCAPE("sinformapago")."' label,'-1' pos ORDER BY `pos` ASC,`label` ASC,`value` ASC"</query>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<colspan>4</colspan>
							<required>true</required>
						</field>
						<field>
							<name>fecha2</name>
							<label lang="true">dateliq</label>
							<type>date</type>
							<width>90px</width>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<colspan>3</colspan>
							<icon>calendar</icon>
						</field>
					</row>
				</fieldset>
			</default>
			<files_old include="xml/common/filesold.xml" />
			<files_new include="xml/common/filesnew.xml"/>
			<vencimientos_old>
				<fieldset>
					<width>700px</width>
					<title lang="true">vencimientos_old</title>
					<head>
						<field>
							<type>label</type>
							<label lang="true">fechavencimiento</label>
							<class>center bold thead</class>
						</field>
						<field>
							<type>label</type>
							<label lang="true">percent</label>
							<class>center bold thead</class>
						</field>
						<field>
							<type>label</type>
							<label lang="true">importe</label>
							<class>center bold thead</class>
						</field>
						<field>
							<type>label</type>
							<label lang="true">pagado</label>
							<class>center bold thead</class>
							<colspan>2</colspan>
						</field>
						<field>
							<type>label</type>
							<label lang="true">fechapagado</label>
							<class>center bold thead</class>
						</field>
						<field global="id" ifeval="$id&gt;=0">
							<type>separator</type>
							<colspan>100</colspan>
							<class>thead</class>
						</field>
					</head>
					<row>
						<field>
							<name>id</name>
							<type>hidden</type>
						</field>
						<field>
							<name>id_gasto</name>
							<type>hidden</type>
						</field>
						<field>
							<name>fecha</name>
							<type>date</type>
							<width>150px</width>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<class>tbody</class>
							<icon>calendar</icon>
						</field>
						<field>
							<name>percent</name>
							<type>text</type>
							<width>100px</width>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<onchange>update_vencimientos(this)</onchange>
							<class>tbody</class>
						</field>
						<field>
							<name>importe</name>
							<type>text</type>
							<width>100px</width>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<onchange>update_vencimientos(this)</onchange>
							<class>tbody</class>
						</field>
						<field>
							<name>pagado</name>
							<type>checkbox</type>
							<label lang="true">pagado</label>
							<value>1</value>
							<width>1px</width>
							<width2>100px</width2>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<class>tbody</class>
							<class2>tbody</class2>
						</field>
						<field>
							<name>fecha2</name>
							<type>date</type>
							<width>150px</width>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<class>tbody</class>
							<icon>calendar</icon>
						</field>
						<field global="id" ifeval="$id&gt;=0">
							<name>delete</name>
							<type>checkbox</type>
							<label lang="true">delete</label>
							<value>1</value>
							<width>1px</width>
							<width2>1px</width2>
							<onchange>update_vencimientos(this)</onchange>
							<icon>delete</icon>
							<class>tbody</class>
							<class2>tbody</class2>
						</field>
					</row>
				</fieldset>
			</vencimientos_old>
			<vencimientos_new>
				<fieldset>
					<width>700px</width>
					<title lang="true">vencimientos_new</title>
					<head>
						<field>
							<type>label</type>
							<label lang="true">fechavencimiento</label>
							<class>center bold thead</class>
						</field>
						<field>
							<type>label</type>
							<label lang="true">percent</label>
							<class>center bold thead</class>
						</field>
						<field>
							<type>label</type>
							<label lang="true">importe</label>
							<class>center bold thead</class>
						</field>
						<field>
							<type>label</type>
							<label lang="true">pagado</label>
							<class>center bold thead</class>
							<colspan>2</colspan>
						</field>
						<field>
							<type>label</type>
							<label lang="true">fechapagado</label>
							<class>center bold thead</class>
						</field>
					</head>
					<row>
						<field>
							<name>id</name>
							<type>hidden</type>
						</field>
						<field>
							<name>id_gasto</name>
							<type>hidden</type>
						</field>
						<field>
							<name>fecha</name>
							<type>date</type>
							<width>150px</width>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<class>tbody</class>
							<icon>calendar</icon>
						</field>
						<field>
							<name>percent</name>
							<type>text</type>
							<width>100px</width>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<onchange>update_vencimientos(this)</onchange>
							<class>tbody</class>
						</field>
						<field>
							<name>importe</name>
							<type>text</type>
							<width>100px</width>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<onchange>update_vencimientos(this)</onchange>
							<class>tbody</class>
						</field>
						<field>
							<name>pagado</name>
							<type>checkbox</type>
							<value>1</value>
							<width>1px</width>
							<width2>100px</width2>
							<label lang="true">pagado</label>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<class>tbody</class>
							<class2>tbody</class2>
						</field>
						<field>
							<name>fecha2</name>
							<type>date</type>
							<width>150px</width>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<class>tbody</class>
							<icon>calendar</icon>
						</field>
					</row>
				</fieldset>
			</vencimientos_new>
			<control include="xml/common/control.xml" />
			<folders include="xml/common/folders.xml" />
			<help include="xml/common/helpform.xml" />
		</fields>
		<quick include="xml/common/quickform.xml" />
		<buttons include="xml/common/buttonsform.xml" />
		<node path="buttons/row/field" before="true">
			<field global="id" ifeval="$id==0">
				<type>button</type>
				<value eval="true">LANG("add","proveedores")</value>
				<tip eval="true">LANG("add","proveedores")</tip>
				<onclick>setParam("page","proveedores");setParam("action","form");submit1()</onclick>
				<disabled eval="true">check_user("proveedores","create")?"false":"true"</disabled>
				<class>nowrap contextmenu</class>
				<icon>create</icon>
			</field>
		</node>
		<javascript>
			<javascript include="xml/common/jsform.xml" replace="true"/>
			<cache>
				<include>js/updateproyectos.js</include>
				<include>js/updatevencimientos.js</include>
			</cache>
		</javascript>
	</form>
	<insert>
		<query include="xml/common/qpermcreate.xml" replace="true"/>
		<query include="xml/common/autonombre.xml" replace="true"/>
		<query match="default" prefix="true" global="page" preeval="true" eval="true">make_insert_query(page2table($page))</query>
		<query include="xml/common/qcontrolinsert.xml" replace="true"/>
		<query include="xml/common/qfilesinsert.xml" replace="true"/>
		<query match="resumen" prefix="true" eval="true">"/*MYSQL SET @__ID__ = (SELECT MAX(id) FROM tbl_gastos) */"</query>
		<query match="vencimientos_new" prefix="true" eval="true">getParam("fecha")?"INSERT INTO tbl_gastos_v(id,id_gasto,fecha,percent,importe,pagado,fecha2) VALUES(NULL,/*MYSQL @__ID__ *//*SQLITE (SELECT MAX(id) FROM tbl_gastos) */,'".dateval(getParam("fecha"))."','".getParam("percent")."','".getParam("importe")."','".intval(getParam("pagado"))."','".dateval(getParam("fecha2"))."')":""</query>
		<query match="default" prefix="true" eval="true">"UPDATE tbl_gastos SET liquidado=(SELECT CASE COUNT(*) WHEN 0 THEN '".intval(getParam("liquidado"))."' ELSE CASE COUNT(*)-SUM(pagado) WHEN 0 THEN 1 ELSE 0 END END liquidado FROM tbl_gastos_v WHERE id_gasto=/*MYSQL @__ID__ *//*SQLITE (SELECT MAX(id) FROM tbl_gastos) */) WHERE id=/*MYSQL @__ID__ *//*SQLITE (SELECT MAX(id) FROM tbl_gastos) */"</query>
		<query eval="true">"SELECT CONCAT('".LANG_ESCAPE("lastinsert")."',LPAD((SELECT MAX(id) FROM tbl_gastos),5,0)) action_alert"</query>
		<query include="xml/common/qfoldersinsert.xml" replace="true"/>
	</insert>
	<update>
		<query include="xml/common/qpermupdate.xml" replace="true"/>
		<query match="default" prefix="true" global="page" preeval="true" eval="true">make_update_query(page2table($page))</query>
        <query include="xml/common/qcontrolupdate.xml" replace="true"/>
		<query include="xml/common/qfilesdelete.xml" replace="true" />
		<query include="xml/common/qfilesupdate.xml" replace="true"/>
		<query match="vencimientos_old" prefix="true" eval="true">"UPDATE tbl_gastos_v SET `fecha`='".dateval(getParam("fecha"))."',`percent`='".getParam("percent")."',`importe`='".getParam("importe")."',`pagado`='".intval(getParam("pagado"))."',`fecha2`='".dateval(getParam("fecha2"))."' WHERE `id`='".getParam("id")."'"</query>
		<query match="vencimientos_old" prefix="true" eval="true">getParam("delete")?"DELETE FROM tbl_gastos_v WHERE `id`='".getParam("id")."'":""</query>
		<query match="vencimientos_new" prefix="true" eval="true">getParam("fecha")?"INSERT INTO tbl_gastos_v(id,id_gasto,fecha,percent,importe,pagado,fecha2) VALUES(NULL,'".intval(getParam("id_gasto"))."','".dateval(getParam("fecha"))."','".getParam("percent")."','".getParam("importe")."','".intval(getParam("pagado"))."','".dateval(getParam("fecha2"))."')":""</query>
		<query match="default" prefix="true" eval="true">"UPDATE tbl_gastos SET liquidado=(SELECT CASE COUNT(*) WHEN 0 THEN '".intval(getParam("liquidado"))."' ELSE CASE COUNT(*)-SUM(pagado) WHEN 0 THEN 1 ELSE 0 END END liquidado FROM tbl_gastos_v WHERE id_gasto='".getParam("id")."') WHERE id='".getParam("id")."'"</query>
		<query eval="true">"SELECT CONCAT('".LANG_ESCAPE("lastupdate")."',LPAD(".getParam("id").",5,0)) action_alert"</query>
		<query include="xml/common/qfoldersupdate.xml" replace="true"/>
	</update>
	<delete>
		<query include="xml/common/qpermdelete.xml" replace="true"/>
		<query include="xml/common/qdelete.xml" replace="true" />
		<query include="xml/common/qdeletefiles.xml" replace="true" />
		<query global="id" eval="true">"DELETE FROM tbl_gastos_v WHERE `id_gasto`='$id'"</query>
		<query include="xml/common/qcontroldelete.xml" replace="true"/>
		<query global="id" eval="true">"SELECT CONCAT('".LANG_ESCAPE("lastdelete")."',LPAD('$id',5,0)) action_alert"</query>
		<query include="xml/common/qfoldersdelete.xml" replace="true"/>
	</delete>
	<excel>
		<query require="php/listsim.php" global="page" eval="true">"SELECT CONCAT('\'',LPAD(id,5,0)) '".LANG_ESCAPE("codigo")."',usuario '".LANG_ESCAPE("username")."',`datetime` '".LANG_ESCAPE("datetime")."',CASE id_epigrafe WHEN '0' THEN '".LANG_ESCAPE("sinepigrafe")."' ELSE (SELECT CONCAT('(',codigo,') ',nombre) FROM tbl_epigrafes WHERE id_epigrafe=tbl_epigrafes.id) END '".LANG_ESCAPE("epigrafe")."',cif '".LANG_ESCAPE("cif")."',CONCAT('\'',num) '".LANG_ESCAPE("numfac")."',fecha '".LANG_ESCAPE("date")."',CASE id_proveedor WHEN '0' THEN '".LANG_ESCAPE("sinproveedor")."' ELSE empresa END '".LANG_ESCAPE("empresa")."',descripcion '".LANG_ESCAPE("descripcion")."',base '".LANG_ESCAPE("base")."',iva '".CONFIG("accounting_iva_name")." (%)',ROUND(base*iva/100,2) '".CONFIG("accounting_iva_name")."',irpf '".CONFIG("accounting_irpf_name")." (%)',ROUND(base*irpf/100,2) '".CONFIG("accounting_irpf_name")."',total '".LANG_ESCAPE("total")."' FROM (SELECT CASE a.id_proveedor WHEN '0' THEN '".LANG_ESCAPE("sinproveedor")."' ELSE b.nombre END empresa2,a.id action_id,a.*,b.nombre empresa,b.cif cif,f.`datetime` `datetime`,".make_extra_query_with_login("g.")." usuario FROM tbl_gastos a LEFT JOIN tbl_proveedores b ON a.id_proveedor=b.id LEFT JOIN tbl_registros_i f ON f.id_aplicacion='".page2id($page)."' AND f.id_registro=a.id LEFT JOIN tbl_usuarios g ON f.id_usuario=g.id) c WHERE id IN (".list_simulator($page).")"</query>
	</excel>
</root>
