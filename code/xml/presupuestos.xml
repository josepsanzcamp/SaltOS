<?xml version="1.0" encoding="UTF-8" ?>
<!--
 ____        _ _    ___  ____
/ ___|  __ _| | |_ / _ \/ ___|
\___ \ / _` | | __| | | \___ \
 ___) | (_| | | |_| |_| |___) |
|____/ \__,_|_|\__|\___/|____/

SaltOS: Framework to develop Rich Internet Applications
Copyright (C) 2007-2018 by Josep Sanz CampderrÃ³s
More information in http://www.saltos.org or info@saltos.org

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<root>
	<list>
		<title lang="true">list</title>
		<icon eval="true">ICON("list")</icon>
		<help>true</help>
		<actions include="xml/common/actions.xml" replace="true"/>
		<width>100%</width>
		<fields>
			<field>
				<name>id2</name>
				<label lang="true">id</label>
				<sort>true</sort>
				<order>id</order>
			</field>
			<field>
				<name>cliente</name>
				<label lang="true">cliente</label>
				<sort>true</sort>
				<size>20</size>
				<order>cliente2</order>
			</field>
			<field>
				<name>nombre</name>
				<label lang="true">presupuesto</label>
				<sort>true</sort>
				<order>nombre2</order>
			</field>
			<field>
				<name>fecha</name>
				<label lang="true">date</label>
				<sort>true</sort>
			</field>
			<field>
				<name>total1</name>
				<label eval="true">LANG("tareas")." (".CONFIG("accounting_currency").")"</label>
				<sort>true</sort>
				<math>
					<func>sum()</func>
					<label eval="true">LANG("suma")." (".CONFIG("accounting_currency").")"</label>
				</math>
			</field>
			<field>
				<name>total2</name>
				<label eval="true">LANG("prod")." (".CONFIG("accounting_currency").")"</label>
				<sort>true</sort>
				<math>
					<func>sum()</func>
					<label eval="true">LANG("suma")." (".CONFIG("accounting_currency").")"</label>
				</math>
			</field>
			<field>
				<name>total3</name>
				<label eval="true">LANG("total")." (".CONFIG("accounting_currency").")"</label>
				<sort>true</sort>
				<math>
					<func>sum()</func>
					<label eval="true">LANG("suma")." (".CONFIG("accounting_currency").")"</label>
				</math>
			</field>
			<field>
				<name>estado</name>
				<label lang="true">estado</label>
				<sort>true</sort>
			</field>
			<field>
				<name>comentarios</name>
				<label lang="true">numc</label>
				<tip lang="true">numctip</tip>
				<sort>false</sort>
			</field>
			<field>
				<name>ficheros</name>
				<label lang="true">numf</label>
				<tip lang="true">numftip</tip>
				<sort>false</sort>
			</field>
			<field>
				<name>tareas</name>
				<label lang="true">numt</label>
				<tip lang="true">numttip</tip>
				<sort>false</sort>
			</field>
			<field>
				<name>productos</name>
				<label lang="true">nump</label>
				<tip lang="true">numptip</tip>
				<sort>false</sort>
			</field>
		</fields>
		<javascript include="xml/common/jslist.xml"/>
		<form>
			<name>list</name>
			<action></action>
			<method>get</method>
			<fields>
				<title lang="true">filter</title>
				<icon eval="true">ICON("filter")</icon>
				<buttons>true</buttons>
				<row>
					<field include="xml/common/hiddenslist.xml" replace="true" />
					<field>
						<name>id_cliente</name>
						<label lang="true">cliente</label>
						<type>select</type>
						<width>240px</width>
						<query eval="true">make_extra_query_with_perms("clientes","tbl_clientes","nombre","SELECT id_cliente FROM tbl_presupuestos")." UNION SELECT '0' value,'".LANG_ESCAPE("sincliente")."' label,-1 pos UNION SELECT '' value,'".LANG_ESCAPE("todoslosclientes")."' label,-1 pos ORDER BY pos ASC,label ASC,value ASC"</query>
						<value global="id_cliente" eval="true">$id_cliente=getParam("id_cliente")</value>
						<colspan>3</colspan>
					</field>
					<field>
						<type>separator</type>
						<width>10px</width>
					</field>
					<field>
						<name>fecha1</name>
						<label lang="true">fechaini</label>
						<type>date</type>
						<width>90px</width>
						<value global="fecha1" eval="true">$fecha1=getParam("fecha1")</value>
						<icon>fa fa-calendar</icon>
						<onchange>check_date("fecha1","le","fecha2")</onchange>
					</field>
					<field>
						<name>fecha2</name>
						<label lang="true">fechafin</label>
						<type>date</type>
						<width>90px</width>
						<value global="fecha2" eval="true">$fecha2=getParam("fecha2")</value>
						<class2>right</class2>
						<icon>fa fa-calendar</icon>
						<onchange>check_date("fecha2","ge","fecha1")</onchange>
					</field>
				</row>
				<row>
					<field>
						<name>id_posiblecli</name>
						<label lang="true">posiblecli</label>
						<type>select</type>
						<width>240px</width>
						<query eval="true">make_extra_query_with_perms("posiblescli","tbl_posiblescli","nombre","SELECT id_posiblecli FROM tbl_presupuestos")." UNION SELECT '0' value,'".LANG_ESCAPE("sinposiblecli")."' label,-1 pos UNION SELECT '' value,'".LANG_ESCAPE("todoslosposiblescli")."' label,-1 pos ORDER BY pos ASC,label ASC,value ASC"</query>
						<value global="id_posiblecli" eval="true">$id_posiblecli=getParam("id_posiblecli")</value>
						<colspan>3</colspan>
					</field>
					<field>
						<type>separator</type>
					</field>
					<field>
						<name>id_campanya</name>
						<label lang="true">campanya</label>
						<type>select</type>
						<width>240px</width>
						<query eval="true">make_extra_query_with_perms("campanyas","tbl_campanyas","nombre")." UNION SELECT '' value,'".LANG_ESCAPE("todaslascampanyas")."' label,'-1' pos UNION SELECT '0' value,'".LANG_ESCAPE("sincampanya")."' label,'-1' pos ORDER BY pos ASC,label ASC,value ASC"</query>
						<value global="id_campanya" eval="true">$id_campanya=getParam("id_campanya")</value>
						<colspan>3</colspan>
					</field>
				</row>
				<row>
					<field>
						<name>filtro</name>
						<label lang="true">filtro</label>
						<type>text</type>
						<width>240px</width>
						<value global="filtro" eval="true">$filtro=getParam("filtro")</value>
						<onchange>copy_value("buscar","filtro");</onchange>
						<colspan>3</colspan>
						<speech>true</speech>
					</field>
					<field>
						<type>separator</type>
					</field>
					<field>
						<name>id_estado</name>
						<label lang="true">estado</label>
						<type>select</type>
						<width>240px</width>
						<query global="page" eval="true">make_extra_query_with_perms("estados","tbl_estados","nombre","SELECT id FROM tbl_estados WHERE id_aplicacion='".page2id($page)."'",true)." UNION SELECT '-1' value,'".LANG_ESCAPE("sinestado")."' label,-1 pos UNION SELECT '' value,'".LANG_ESCAPE("allstates")."' label,-1 pos UNION SELECT 'allenabled' value,'".LANG_ESCAPE("allenabled")."' label,-1 pos UNION SELECT 'alldisabled' value,'".LANG_ESCAPE("alldisabled")."' label,-1 pos ORDER BY pos ASC,label ASC,value ASC"</query>
						<value global="id_estado" eval="true">$id_estado=getParam("id_estado")</value>
						<colspan>3</colspan>
					</field>
				</row>
			</fields>
			<fields include="xml/common/filters.xml" replace="true" />
			<fields ifeval="!ismobile()">
				<title lang="true">graficas</title>
				<icon eval="true">ICON("plots")</icon>
				<row>
					<field>
						<type>plot</type>
						<width eval="true">CONFIG("plot_list_width")."px"</width>
						<height eval="true">CONFIG("plot_list_height")."px"</height>
						<vars>1</vars>
						<graph>bars</graph>
						<title lang="true">plotseguimientoestados</title>
						<query eval="true">"SELECT CASE a.id_estado WHEN '0' THEN '".LANG_ESCAPE("sinestado")."' ELSE CASE WHEN LENGTH(b.nombre)>10 THEN CONCAT(SUBSTR(b.nombre,1,10),'...') ELSE b.nombre END END y0,COUNT(*) y1 FROM tbl_presupuestos a LEFT JOIN tbl_estados b ON b.id=a.id_estado GROUP BY y0 ORDER BY b.pos ASC,y0 ASC"</query>
					</field>
					<field>
						<type>plot</type>
						<width eval="true">CONFIG("plot_list_width")."px"</width>
						<height eval="true">CONFIG("plot_list_height")."px"</height>
						<vars>1</vars>
						<graph>pie</graph>
						<title lang="true">plotseguimientoestados</title>
						<query eval="true">"SELECT CASE a.id_estado WHEN '0' THEN '".LANG_ESCAPE("sinestado")."' ELSE CASE WHEN LENGTH(b.nombre)>10 THEN CONCAT(SUBSTR(b.nombre,1,10),'...') ELSE b.nombre END END y0,COUNT(*) y1 FROM tbl_presupuestos a LEFT JOIN tbl_estados b ON b.id=a.id_estado GROUP BY y0 ORDER BY b.pos ASC,y0 ASC"</query>
					</field>
				</row>
			</fields>
			<buttons include="xml/common/buttonslist.xml" />
		</form>
		<quick>
			<row>
				<field>
					<type>button</type>
					<value lang="true">create</value>
					<tip lang="true">create</tip>
					<onclick>create()</onclick>
					<icon>fa fa-plus-circle</icon>
					<class>nowrap contextmenu</class>
					<class2>shortcut_ctrl_insert</class2>
					<disabled global="page" eval="true">check_user($page,"create")?"false":"true"</disabled>
				</field>
				<field>
					<type>separator</type>
					<width>100%</width>
				</field>
				<field global="limit" ifeval="$limit&gt;=200">
					<type>label</type>
					<label global="limit" eval="true">str_replace('$limit',$limit,LANG("biglist"))</label>
					<tip global="limit" eval="true">str_replace('$limit',$limit,LANG("biglisttip"))</tip>
					<class>nowrap</class>
					<class2>info</class2>
				</field>
				<field ifeval="!ismobile() &amp;&amp; check_filter(array('fecha1'=>'','fecha2'=>'','id_cliente'=>'','id_estado'=>'','filtro'=>'','id_posiblecli'=>'','id_campanya'=>''))">
					<type>label</type>
					<label lang="true">usedfilter</label>
					<class>nowrap</class>
					<class2>info</class2>
				</field>
				<field>
					<name>buscar</name>
					<label lang="true">buscar</label>
					<type>text</type>
					<width>240px</width>
					<value global="filtro" eval="true">$filtro=getParam("filtro")</value>
					<onchange>copy_value("filtro","buscar");</onchange>
					<onkey>if(is_enterkey(event)) { copy_value("filtro","buscar");buscar(); }</onkey>
					<focus>true</focus>
					<speech>true</speech>
					<class3>shortcut_ctrl_f</class3>
				</field>
				<field>
					<type>button</type>
					<value lang="true">buscar</value>
					<tip lang="true">buscartip</tip>
					<onclick>buscar()</onclick>
					<icon>fa fa-search</icon>
					<class>nowrap</class>
				</field>
				<field>
					<type>button</type>
					<value lang="true">pdf</value>
					<tip lang="true">pdftip</tip>
					<onclick>pdf()</onclick>
					<icon>fa fa-file-pdf-o</icon>
					<class>nowrap contextmenu</class>
				</field>
				<field ifeval="!ismobile()">
					<type>button</type>
					<value lang="true">view2</value>
					<tip lang="true">view2tip</tip>
					<onclick>view4()</onclick>
					<icon>fa fa-desktop</icon>
					<class>nowrap contextmenu</class>
				</field>
				<field>
					<type>button</type>
					<value lang="true">mail</value>
					<tip lang="true">mailtip</tip>
					<onclick>mail()</onclick>
					<icon>fa fa-envelope-o</icon>
					<class>nowrap contextmenu</class>
				</field>
				<field>
					<type>button</type>
					<value lang="true">limpiar</value>
					<tip lang="true">limpiartip</tip>
					<onclick>limpiar()</onclick>
					<icon>fa fa-refresh</icon>
					<class>nowrap contextmenu</class>
				</field>
			</row>
		</quick>
		<pager include="xml/common/pagerlist.xml"/>
		<query global="page,id_cliente,id_estado,fecha1,fecha2,filtro,id_posiblecli,id_campanya" eval="true">"SELECT id2,id,usuario,datetime,cliente,cliente2,nombre,nombre2,fecha,total1,total2,total3,estado,comentarios,ficheros,tareas,productos,descripcion,id_campanya,action_id,action_title,action_view,action_edit,action_copy,action_pdf2,action_view2,action_mail,action_delete,id_usuario,id_estado,id_cliente,id_posiblecli,id_grupo,activo,id_proyecto FROM (
			SELECT LPAD(a.id,".intval(CONFIG("zero_padding_digits")).",0) id2,a.id id,
				".make_extra_query_with_login("d.")." usuario,
				e.datetime datetime,
				CASE
					WHEN a.id_cliente!='0' THEN CONCAT('link:openapp(\'clientes\',',-a.id_cliente,'):',b1.nombre)
					WHEN a.id_posiblecli!='0' THEN CONCAT('link:openapp(\'posiblescli\',',-a.id_posiblecli,'):',b2.nombre)
					ELSE '".LANG_ESCAPE("sincliente")."'
				END cliente,
				CASE
					WHEN a.id_cliente!='0' THEN b1.nombre
					WHEN a.id_posiblecli!='0' THEN b2.nombre
					ELSE '".LANG_ESCAPE("sincliente")."'
				END cliente2,
				CONCAT('link:openapp(\'presupuestos\',',-a.id,'):',a.nombre) nombre,
				a.nombre nombre2,
				a.fecha fecha,
				IFNULL((SELECT ROUND(SUM(precio*horas*(100.0-descuento)/100.0),2) FROM tbl_presupuestos_t WHERE id_presupuesto=a.id),0.0) total1,
				IFNULL((SELECT ROUND(SUM(precio*unidades*(100.0-descuento)/100.0),2) FROM tbl_presupuestos_p WHERE id_presupuesto=a.id),0.0) total2,
				IFNULL((SELECT ROUND(SUM(precio*horas*(100.0-descuento)/100.0),2) FROM tbl_presupuestos_t WHERE id_presupuesto=a.id),0.0)+IFNULL((SELECT ROUND(SUM(precio*unidades*(100.0-descuento)/100.0),2) FROM tbl_presupuestos_p WHERE id_presupuesto=a.id),0.0) total3,
				CASE a.id_estado WHEN '0' THEN '".LANG_ESCAPE("sinestado")."' ELSE c.nombre END estado,
				(SELECT COUNT(*) FROM tbl_comentarios WHERE id_aplicacion='".page2id($page)."' AND id_registro=a.id) comentarios,
				(SELECT COUNT(*) FROM tbl_ficheros WHERE id_aplicacion='".page2id($page)."' AND id_registro=a.id) ficheros,
				(SELECT COUNT(*) FROM tbl_presupuestos_t WHERE id_presupuesto=a.id) tareas,
				(SELECT COUNT(*) FROM tbl_presupuestos_p WHERE id_presupuesto=a.id) productos,
				a.descripcion descripcion,a.id_campanya id_campanya,
				a.id action_id,CONCAT(LPAD(a.id,".intval(CONFIG("zero_padding_digits")).",0),' - ',a.nombre) action_title,
				CASE ".check_sql($page,"view")." WHEN 1 THEN 'true' ELSE 'false' END action_view,
				CASE ".check_sql($page,"edit")." WHEN 1 THEN 'true' ELSE 'false' END action_edit,
				CASE (".check_user($page,"create")." AND (".check_sql($page,"view")." OR ".check_sql($page,"edit").")) WHEN 1 THEN 'true' ELSE 'false' END action_copy,
				CASE ".check_sql($page,"view")." WHEN 1 THEN 'true' ELSE 'false' END action_pdf2,
				CASE ".check_sql($page,"view")." WHEN 1 THEN 'true' ELSE 'false' END action_view2,
				CASE (".check_user("correo","create")." AND ".check_sql($page,"view").") WHEN 1 THEN 'true' ELSE 'false' END action_mail,
				CASE ".check_sql($page,"delete")." WHEN 1 THEN 'true' ELSE 'false' END action_delete,
				id_usuario,a.id_estado id_estado,a.id_cliente id_cliente,a.id_posiblecli id_posiblecli,d.id_grupo id_grupo,c.activo activo,a.id_proyecto id_proyecto
			FROM tbl_presupuestos a
			LEFT JOIN tbl_clientes b1 ON b1.id=a.id_cliente
			LEFT JOIN tbl_posiblescli b2 ON b2.id=a.id_posiblecli
			LEFT JOIN tbl_estados c ON a.id_estado=c.id
			LEFT JOIN tbl_registros e ON e.id_aplicacion='".page2id($page)."' AND e.id_registro=a.id AND e.first=1
			LEFT JOIN tbl_usuarios d ON e.id_usuario=d.id
			) z
			WHERE 1=1
			AND ".($filtro!=""?"id IN (SELECT id_registro FROM tbl_indexing WHERE ".make_fulltext_query2($filtro,page2id($page)).")":"(1=1)")."
			AND ".($id_cliente?"(id_cliente='$id_cliente')":"(1=1)")." AND ".($id_posiblecli?"(id_posiblecli='$id_posiblecli')":"(1=1)")." AND (id_estado='".intval($id_estado)."' OR ''='$id_estado' OR ('allenabled'='$id_estado' AND activo=1) OR ('alldisabled'='$id_estado' AND activo=0)) AND ".($fecha1?"(DATE(datetime)>=DATE('$fecha1'))":"(1=1)")." AND ".($fecha2?"(DATE('$fecha2')>=DATE(datetime))":"(1=1)")." AND ".($id_campanya?"(id_campanya='$id_campanya')":"(1=1)")." AND ".check_sql($page,"list")</query>
		<order global="order" eval="true">$order</order>
		<limit global="limit" eval="true">$limit</limit>
		<offset global="offset" eval="true">$offset</offset>
	</list>
	<form>
		<views>
			<view>
				<title lang="true">formview</title>
				<query>
					<query include="xml/common/qpermview.xml" replace="true" />
					<default global="page,id" eval="true">"SELECT *,(SELECT CASE cif WHEN '' THEN nombre ELSE CONCAT(nombre,' (',cif,')') END FROM tbl_clientes WHERE id=id_cliente) nombre_cliente FROM ".page2table($page)." WHERE id=".abs($id)</default>
					<resumen>
						<resumen>SELECT '1' id</resumen>
					</resumen>
					<detalle global="page,id" eval="true">"SELECT * FROM tbl_presupuestos WHERE id=".abs($id)</detalle>
					<tareas_head>
						<tareas_head>SELECT '1' id</tareas_head>
					</tareas_head>
					<tareas_old>
						<tareas_old global="id" eval="true">"SELECT *,ROUND(horas*precio*(100.0-descuento)/100.0,2) total2 FROM tbl_presupuestos_t WHERE id_presupuesto=".abs($id)." ORDER BY id ASC"</tareas_old>
					</tareas_old>
					<products_head>
						<products_head>SELECT '1' id</products_head>
					</products_head>
					<products_old>
						<products_old global="id" eval="true">"SELECT *,ROUND(precio*unidades*(100.0-descuento)/100.0,2) total2 FROM tbl_presupuestos_p WHERE id_presupuesto=".abs($id)." ORDER BY id ASC"</products_old>
					</products_old>
					<condiciones global="page,id" eval="true">"SELECT * FROM tbl_presupuestos WHERE id=".abs($id)</condiciones>
					<comments_old include="xml/common/qcommentsold.xml" />
					<files_old include="xml/common/qfilesold.xml" />
					<agenda>
						<agenda global="id" eval="true">"SELECT id_usuario,id_grupo,LPAD(id,".intval(CONFIG("zero_padding_digits")).",0) id,dstart,dstop,CONCAT('link:openapp(\'agenda\',',-id,'):',nombre) nombre,CASE id_estado WHEN '0' THEN '".LANG_ESCAPE("sinestado")."' ELSE c_nombre END estado,CONCAT('agenda(',-id,')') link_view FROM (SELECT id_usuario,id_grupo,a.*,c.nombre c_nombre,x.nombre x_nombre FROM tbl_agenda a LEFT JOIN tbl_estados c ON id_estado=c.id LEFT JOIN tbl_tiposevento x ON x.id=id_tipoevento LEFT JOIN tbl_registros e ON e.id_aplicacion='".page2id("agenda")."' AND e.id_registro=a.id AND e.first=1 LEFT JOIN tbl_usuarios b ON e.id_usuario=b.id) z WHERE id_presupuesto=".abs($id)." AND (".check_sql("agenda","view").") ORDER BY dstart DESC"</agenda>
					</agenda>
					<actas>
						<actas global="id" eval="true">"SELECT id_usuario,id_grupo,LPAD(id,".intval(CONFIG("zero_padding_digits")).",0) id,dstart,dstop,CONCAT('link:openapp(\'actas\',',-id,'):',nombre) nombre,CONCAT('actas(',-id,')') link_view,CONCAT('pdfacta(',id,')') link_pdf,CONCAT('mailacta(',id,')') link_mail FROM (SELECT id_usuario,id_grupo,a.* FROM tbl_actas a LEFT JOIN tbl_registros e ON e.id_aplicacion='".page2id("actas")."' AND e.id_registro=a.id AND e.first=1 LEFT JOIN tbl_usuarios b ON e.id_usuario=b.id) z WHERE id_presupuesto=".abs($id)." AND (".check_sql("actas","view").") ORDER BY id DESC"</actas>
					</actas>
					<control include="xml/common/qcontrol.xml"/>
					<folders include="xml/common/qfolders.xml" />
				</query>
			</view>
			<insert>
				<title lang="true">forminsert</title>
				<query>
					<query include="xml/common/qpermcreate.xml" replace="true" />
					<default eval="true">substr(getParam("id"),0,7)=="0_copy_"?"SELECT *,'".CONFIG('df_estado_presupuestos')."' id_estado,'".current_date()."' fecha FROM tbl_presupuestos WHERE id='".substr(getParam("id"),7)."'":"SELECT '0' id,'0' id_cliente,'".CONFIG('df_estado_presupuestos')."' id_estado,'0' id_posiblecli,'".current_date()."' fecha,'0' id_campanya"</default>
					<resumen>
						<resumen>SELECT '1' id</resumen>
					</resumen>
					<detalle eval="true">substr(getParam("id"),0,7)=="0_copy_"?"SELECT * FROM tbl_presupuestos WHERE id='".substr(getParam("id"),7)."'":"SELECT '0' id"</detalle>
					<tareas_head>
						<tareas_head>SELECT '1' id</tareas_head>
					</tareas_head>
					<tareas_new>
						<tareas_new eval="true">substr(getParam("id"),0,7)=="0_copy_"?"
						SELECT id,tarea,horas,descuento,precio,ROUND(horas*precio*(100.0-descuento)/100.0,2) total2 FROM tbl_presupuestos_t WHERE id_presupuesto='".substr(getParam("id"),7)."' UNION
						SELECT 'a' id,'' tarea,'0.00' horas,'0.00' descuento,'0.00' precio,'0.00' total2 UNION
						SELECT 'b' id,'' tarea,'0.00' horas,'0.00' descuento,'0.00' precio,'0.00' total2 UNION
						SELECT 'c' id,'' tarea,'0.00' horas,'0.00' descuento,'0.00' precio,'0.00' total2 UNION
						SELECT 'd' id,'' tarea,'0.00' horas,'0.00' descuento,'0.00' precio,'0.00' total2 UNION
						SELECT 'e' id,'' tarea,'0.00' horas,'0.00' descuento,'0.00' precio,'0.00' total2":"
						SELECT 'a' id,'0.00' horas,'0.00' descuento,'0.00' precio,'0.00' total2 UNION
						SELECT 'b' id,'0.00' horas,'0.00' descuento,'0.00' precio,'0.00' total2 UNION
						SELECT 'c' id,'0.00' horas,'0.00' descuento,'0.00' precio,'0.00' total2 UNION
						SELECT 'd' id,'0.00' horas,'0.00' descuento,'0.00' precio,'0.00' total2 UNION
						SELECT 'e' id,'0.00' horas,'0.00' descuento,'0.00' precio,'0.00' total2 UNION
						SELECT 'f' id,'0.00' horas,'0.00' descuento,'0.00' precio,'0.00' total2 UNION
						SELECT 'g' id,'0.00' horas,'0.00' descuento,'0.00' precio,'0.00' total2 UNION
						SELECT 'h' id,'0.00' horas,'0.00' descuento,'0.00' precio,'0.00' total2 UNION
						SELECT 'i' id,'0.00' horas,'0.00' descuento,'0.00' precio,'0.00' total2 UNION
						SELECT 'j' id,'0.00' horas,'0.00' descuento,'0.00' precio,'0.00' total2"</tareas_new>
					</tareas_new>
					<products_head>
						<products_head>SELECT '1' id</products_head>
					</products_head>
					<products_new>
						<products_new eval="true">substr(getParam("id"),0,7)=="0_copy_"?"
						SELECT id,descuento,id_producto,concepto,unidades,precio,ROUND(unidades*precio*(100.0-descuento)/100.0,2) total2 FROM tbl_presupuestos_p WHERE id_presupuesto='".substr(getParam("id"),7)."' UNION
						SELECT 'a' id,'0.00' descuento,'0' id_producto,'' concepto,'0.00' unidades,'0.00' precio,'0.00' total2 UNION
						SELECT 'b' id,'0.00' descuento,'0' id_producto,'' concepto,'0.00' unidades,'0.00' precio,'0.00' total2 UNION
						SELECT 'c' id,'0.00' descuento,'0' id_producto,'' concepto,'0.00' unidades,'0.00' precio,'0.00' total2 UNION
						SELECT 'd' id,'0.00' descuento,'0' id_producto,'' concepto,'0.00' unidades,'0.00' precio,'0.00' total2 UNION
						SELECT 'e' id,'0.00' descuento,'0' id_producto,'' concepto,'0.00' unidades,'0.00' precio,'0.00' total2":"
						SELECT 'a' id,'0.00' descuento,'0' id_producto,'' concepto,'0.00' unidades,'0.00' precio,'0.00' total2 UNION
						SELECT 'b' id,'0.00' descuento,'0' id_producto,'' concepto,'0.00' unidades,'0.00' precio,'0.00' total2 UNION
						SELECT 'c' id,'0.00' descuento,'0' id_producto,'' concepto,'0.00' unidades,'0.00' precio,'0.00' total2 UNION
						SELECT 'd' id,'0.00' descuento,'0' id_producto,'' concepto,'0.00' unidades,'0.00' precio,'0.00' total2 UNION
						SELECT 'e' id,'0.00' descuento,'0' id_producto,'' concepto,'0.00' unidades,'0.00' precio,'0.00' total2 UNION
						SELECT 'f' id,'0.00' descuento,'0' id_producto,'' concepto,'0.00' unidades,'0.00' precio,'0.00' total2 UNION
						SELECT 'g' id,'0.00' descuento,'0' id_producto,'' concepto,'0.00' unidades,'0.00' precio,'0.00' total2 UNION
						SELECT 'h' id,'0.00' descuento,'0' id_producto,'' concepto,'0.00' unidades,'0.00' precio,'0.00' total2 UNION
						SELECT 'i' id,'0.00' descuento,'0' id_producto,'' concepto,'0.00' unidades,'0.00' precio,'0.00' total2 UNION
						SELECT 'j' id,'0.00' descuento,'0' id_producto,'' concepto,'0.00' unidades,'0.00' precio,'0.00' total2
						"</products_new>
					</products_new>
					<condiciones eval="true">substr(getParam("id"),0,7)=="0_copy_"?"SELECT * FROM tbl_presupuestos WHERE id='".substr(getParam("id"),7)."'":"SELECT '0' id"</condiciones>
					<files_new include="xml/common/qfilesnew.xml" replace="true"/>
					<folders include="xml/common/qfolders.xml" />
				</query>
			</insert>
			<update>
				<title lang="true">formupdate</title>
				<query>
					<query include="xml/common/qpermupdate.xml" replace="true" />
					<default global="page,id" eval="true">"SELECT *,(SELECT CASE cif WHEN '' THEN nombre ELSE CONCAT(nombre,' (',cif,')') END FROM tbl_clientes WHERE id=id_cliente) nombre_cliente FROM ".page2table($page)." WHERE id=".abs($id)</default>
					<resumen>
						<resumen>SELECT '1' id</resumen>
					</resumen>
					<detalle global="page,id" eval="true">"SELECT * FROM tbl_presupuestos WHERE id=".abs($id)</detalle>
					<tareas_head>
						<tareas_head>SELECT '1' id</tareas_head>
					</tareas_head>
					<tareas_old>
						<tareas_old global="id" eval="true">"SELECT *,ROUND(horas*precio*(100.0-descuento)/100.0,2) total2 FROM tbl_presupuestos_t WHERE id_presupuesto=".abs($id)." ORDER BY id ASC"</tareas_old>
					</tareas_old>
					<tareas_new>
						<tareas_new global="id" eval="true">"
						SELECT 'a' id,'$id' id_presupuesto,'0.00' horas,'0.00' descuento,'0.00' precio,'0.00' total2 UNION
						SELECT 'b' id,'$id' id_presupuesto,'0.00' horas,'0.00' descuento,'0.00' precio,'0.00' total2 UNION
						SELECT 'c' id,'$id' id_presupuesto,'0.00' horas,'0.00' descuento,'0.00' precio,'0.00' total2 UNION
						SELECT 'd' id,'$id' id_presupuesto,'0.00' horas,'0.00' descuento,'0.00' precio,'0.00' total2 UNION
						SELECT 'e' id,'$id' id_presupuesto,'0.00' horas,'0.00' descuento,'0.00' precio,'0.00' total2 UNION
						SELECT 'f' id,'$id' id_presupuesto,'0.00' horas,'0.00' descuento,'0.00' precio,'0.00' total2 UNION
						SELECT 'g' id,'$id' id_presupuesto,'0.00' horas,'0.00' descuento,'0.00' precio,'0.00' total2 UNION
						SELECT 'h' id,'$id' id_presupuesto,'0.00' horas,'0.00' descuento,'0.00' precio,'0.00' total2 UNION
						SELECT 'i' id,'$id' id_presupuesto,'0.00' horas,'0.00' descuento,'0.00' precio,'0.00' total2 UNION
						SELECT 'j' id,'$id' id_presupuesto,'0.00' horas,'0.00' descuento,'0.00' precio,'0.00' total2"</tareas_new>
					</tareas_new>
					<products_head>
						<products_head>SELECT '1' id</products_head>
					</products_head>
					<products_old>
						<products_old global="id" eval="true">"SELECT *,ROUND(precio*unidades*(100.0-descuento)/100.0,2) total2 FROM tbl_presupuestos_p WHERE id_presupuesto=".abs($id)." ORDER BY id ASC"</products_old>
					</products_old>
					<products_new>
						<products_new global="id" eval="true">"
						SELECT 'a' id,'$id' id_presupuesto,'0.00' descuento,'0' id_producto,'' concepto,'0.00' unidades,'0.00' precio,'0.00' total2 UNION
						SELECT 'b' id,'$id' id_presupuesto,'0.00' descuento,'0' id_producto,'' concepto,'0.00' unidades,'0.00' precio,'0.00' total2 UNION
						SELECT 'c' id,'$id' id_presupuesto,'0.00' descuento,'0' id_producto,'' concepto,'0.00' unidades,'0.00' precio,'0.00' total2 UNION
						SELECT 'd' id,'$id' id_presupuesto,'0.00' descuento,'0' id_producto,'' concepto,'0.00' unidades,'0.00' precio,'0.00' total2 UNION
						SELECT 'e' id,'$id' id_presupuesto,'0.00' descuento,'0' id_producto,'' concepto,'0.00' unidades,'0.00' precio,'0.00' total2 UNION
						SELECT 'f' id,'$id' id_presupuesto,'0.00' descuento,'0' id_producto,'' concepto,'0.00' unidades,'0.00' precio,'0.00' total2 UNION
						SELECT 'g' id,'$id' id_presupuesto,'0.00' descuento,'0' id_producto,'' concepto,'0.00' unidades,'0.00' precio,'0.00' total2 UNION
						SELECT 'h' id,'$id' id_presupuesto,'0.00' descuento,'0' id_producto,'' concepto,'0.00' unidades,'0.00' precio,'0.00' total2 UNION
						SELECT 'i' id,'$id' id_presupuesto,'0.00' descuento,'0' id_producto,'' concepto,'0.00' unidades,'0.00' precio,'0.00' total2 UNION
						SELECT 'j' id,'$id' id_presupuesto,'0.00' descuento,'0' id_producto,'' concepto,'0.00' unidades,'0.00' precio,'0.00' total2"</products_new>
					</products_new>
					<condiciones global="page,id" eval="true">"SELECT * FROM tbl_presupuestos WHERE id=".abs($id)</condiciones>
					<comments_old include="xml/common/qcommentsold.xml" />
					<files_old include="xml/common/qfilesold.xml" />
					<comments_new include="xml/common/qcommentnew.xml" replace="true"/>
					<files_new include="xml/common/qfilesnew.xml" replace="true"/>
					<control include="xml/common/qcontrol.xml"/>
					<folders include="xml/common/qfolders.xml" />
				</query>
			</update>
		</views>
		<name>form</name>
		<action></action>
		<method>post</method>
		<hiddens include="xml/common/hiddensform.xml" />
		<help>true</help>
		<fields>
			<default>
				<fieldset>
					<title lang="true">defaultdata</title>
					<icon eval="true">ICON("form")</icon>
					<quick global="id" eval="true">$id>=0?"false":"true"</quick>
					<row>
						<field>
							<name>id</name>
							<type>hidden</type>
						</field>
						<field>
							<name>id_posiblecli</name>
							<label lang="true">posiblecli</label>
							<type>select</type>
							<width>240px</width>
							<query eval="true">make_extra_query_with_perms("posiblescli","tbl_posiblescli","nombre","SELECT id FROM tbl_posiblescli WHERE activo='1'")." UNION SELECT '0' value,'".LANG_ESCAPE("sinposiblecli")."' label,'-1' pos ORDER BY pos ASC,label ASC,value ASC"</query>
							<focus global="id" eval="true">$id>=0?"true":"false"</focus>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<link>openapp('posiblescli',-abs(ID))</link>
							<icon>fa fa-search</icon>
							<onchange>$("input[name$=id_cliente]").val(0);$("input[name$=nombre_cliente]").val("");update_proyectos()</onchange>
						</field>
						<field>
							<name>id_campanya</name>
							<label lang="true">campanya</label>
							<type>select</type>
							<width>240px</width>
							<query eval="true">make_extra_query_with_perms("campanyas","tbl_campanyas","nombre")." UNION SELECT '0' value,'".LANG_ESCAPE("sincampanya")."' label,'-1' pos ORDER BY pos ASC,label ASC,value ASC"</query>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<link>openapp('campanyas',-abs(ID))</link>
							<icon>fa fa-search</icon>
						</field>
					</row>
					<row>
						<field>
							<name>id_cliente</name>
							<type>hidden</type>
						</field>
						<field>
							<name>nombre_cliente</name>
							<label lang="true">cliente</label>
							<type>text</type>
							<width>240px</width>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<autocomplete>true</autocomplete>
							<querycomplete>clientes</querycomplete>
							<oncomplete>
								$("#"+prefix+"id_cliente").val(ui.item.id);
								$("select[name$=id_posiblecli]").val(0);
								update_proyectos();
							</oncomplete>
							<link>openapp('clientes',-abs(ID))</link>
							<icon>fa fa-search</icon>
						</field>
						<field>
							<name>id_proyecto</name>
							<label lang="true">proyecto</label>
							<type>select</type>
							<width>240px</width>
							<query eval="true">"SELECT '' value,'".LANG_ESCAPE("sinproyecto")."' label"</query>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<link>openapp('proyectos',-abs(ID))</link>
							<icon>fa fa-search</icon>
						</field>
					</row>
					<row>
						<field>
							<type>separator</type>
						</field>
					</row>
					<row>
						<field>
							<name>nombre</name>
							<label lang="true">nombre</label>
							<type>text</type>
							<width>240px</width>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<required>true</required>
							<speech>true</speech>
						</field>
						<field>
							<name>fecha</name>
							<label lang="true">date</label>
							<type>date</type>
							<width>90px</width>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<icon>fa fa-calendar</icon>
						</field>
					</row>
					<row>
						<field>
							<type>separator</type>
							<colspan>2</colspan>
						</field>
						<field>
							<name>id_estado</name>
							<label lang="true">estado</label>
							<type>select</type>
							<width>240px</width>
							<query global="page" eval="true">make_extra_query_with_perms("estados","tbl_estados","nombre","SELECT id FROM tbl_estados WHERE id_aplicacion='".page2id($page)."'",true)." UNION SELECT '0' value,'".LANG_ESCAPE("sinestado")."' label,-1 pos ORDER BY pos ASC,label ASC,value ASC"</query>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
						</field>
					</row>
					<row>
						<field>
							<type>separator</type>
						</field>
					</row>
					<row>
						<field>
							<name>descripcion</name>
							<label lang="true">descripcion</label>
							<type>textarea</type>
							<width>600px</width>
							<height>120px</height>
							<colspan>3</colspan>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<required>true</required>
						</field>
					</row>
				</fieldset>
			</default>
			<resumen>
				<fieldset>
					<width>700px</width>
					<buttons>true</buttons>
					<head>
						<field>
							<type>separator</type>
							<class>thead</class>
						</field>
						<field>
							<type>label</type>
							<label lang="true">horastotal</label>
							<class>center bold thead</class>
						</field>
						<field>
							<type>label</type>
							<label lang="true">unidadestotal</label>
							<class>center bold thead</class>
						</field>
						<field>
							<type>label</type>
							<label eval="true">LANG("preciototal")." (".CONFIG("accounting_currency").")"</label>
							<class>center bold thead</class>
						</field>
					</head>
					<head>
						<field>
							<type>label</type>
							<label lang="true">tareaspresupuesto</label>
							<class>center bold thead</class>
						</field>
						<field>
							<name>horastotal</name>
							<type>text</type>
							<readonly>true</readonly>
							<class>tbody</class>
							<width>120px</width>
						</field>
						<field>
							<name></name>
							<type>text</type>
							<readonly>true</readonly>
							<class>tbody</class>
							<width>120px</width>
						</field>
						<field>
							<name>preciototal</name>
							<type>text</type>
							<readonly>true</readonly>
							<class>tbody</class>
							<width>120px</width>
						</field>
					</head>
					<head>
						<field>
							<type>label</type>
							<label lang="true">productospresupuesto</label>
							<class>center bold thead</class>
						</field>
						<field>
							<name></name>
							<type>text</type>
							<readonly>true</readonly>
							<class>tbody</class>
							<width>120px</width>
						</field>
						<field>
							<name>unidadestotal</name>
							<type>text</type>
							<readonly>true</readonly>
							<class>tbody</class>
							<width>120px</width>
						</field>
						<field>
							<name>preciototal4</name>
							<type>text</type>
							<readonly>true</readonly>
							<class>tbody</class>
							<width>120px</width>
						</field>
					</head>
					<head>
						<field>
							<type>label</type>
							<label lang="true">total</label>
							<class>center bold thead</class>
						</field>
						<field>
							<name>horastotal</name>
							<type>text</type>
							<readonly>true</readonly>
							<class>tbody</class>
							<width>120px</width>
						</field>
						<field>
							<name>unidadestotal</name>
							<type>text</type>
							<readonly>true</readonly>
							<class>tbody</class>
							<width>120px</width>
						</field>
						<field>
							<name>preciototal5</name>
							<type>text</type>
							<readonly>true</readonly>
							<class>tbody</class>
							<width>120px</width>
						</field>
					</head>
				</fieldset>
			</resumen>
			<detalle>
				<fieldset global="id" ifeval="CONFIG('tab_objetivos_presupuesto')&gt;1 &amp;&amp; execute_query('SELECT LENGTH(objetivos) hasdata FROM tbl_presupuestos WHERE id='.abs($id)) || ($id>=0)">
					<title lang="true">objetivos</title>
					<icon eval="true">ICON("form")</icon>
					<row>
						<field>
							<name>id</name>
							<type>hidden</type>
						</field>
						<field>
							<name>objetivos</name>
							<label lang="true">objetivos</label>
							<type>textarea</type>
							<width>600px</width>
							<height>240px</height>
							<colspan>4</colspan>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
						</field>
					</row>
					<row global="id" ifeval="$id&gt;=0">
						<field ifeval="!ismobile()">
							<name>textos_objetivos</name>
							<label lang="true">textos</label>
							<type>select</type>
							<width>240px</width>
							<query include="xml/common/qtextos.xml" replace="true"/>
							<value></value>
						</field>
						<field>
							<type>button</type>
							<value lang="true">textos_add</value>
							<icon>fa fa-plus-circle</icon>
							<onclick>add_textos_textarea('textos_objetivos','objetivos')</onclick>
						</field>
					</row>
				</fieldset>
				<fieldset global="id" ifeval="CONFIG('tab_funcional_presupuesto')&gt;1 &amp;&amp; execute_query('SELECT LENGTH(funcional) hasdata FROM tbl_presupuestos WHERE id='.abs($id)) || ($id>=0)">
					<title lang="true">funcional</title>
					<icon eval="true">ICON("form")</icon>
					<row>
						<field>
							<name>funcional</name>
							<label lang="true">funcional</label>
							<type>textarea</type>
							<width>600px</width>
							<height>240px</height>
							<colspan>4</colspan>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
						</field>
					</row>
					<row global="id" ifeval="$id&gt;=0">
						<field ifeval="!ismobile()">
							<name>textos_funcional</name>
							<label lang="true">textos</label>
							<type>select</type>
							<width>240px</width>
							<query include="xml/common/qtextos.xml" replace="true"/>
							<value></value>
						</field>
						<field>
							<type>button</type>
							<value lang="true">textos_add</value>
							<icon>fa fa-plus-circle</icon>
							<onclick>add_textos_textarea('textos_funcional','funcional')</onclick>
						</field>
					</row>
				</fieldset>
				<fieldset global="id" ifeval="CONFIG('tab_tecnica_presupuesto')&gt;1 &amp;&amp; execute_query('SELECT LENGTH(tecnica) hasdata FROM tbl_presupuestos WHERE id='.abs($id)) || ($id>=0)">
					<title lang="true">tecnica</title>
					<icon eval="true">ICON("form")</icon>
					<row>
						<field>
							<name>tecnica</name>
							<label lang="true">tecnica</label>
							<type>textarea</type>
							<width>600px</width>
							<height>240px</height>
							<colspan>4</colspan>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
						</field>
					</row>
					<row global="id" ifeval="$id&gt;=0">
						<field ifeval="!ismobile()">
							<name>textos_tecnica</name>
							<label lang="true">textos</label>
							<type>select</type>
							<width>240px</width>
							<query include="xml/common/qtextos.xml" replace="true"/>
							<value></value>
						</field>
						<field>
							<type>button</type>
							<value lang="true">textos_add</value>
							<icon>fa fa-plus-circle</icon>
							<onclick>add_textos_textarea('textos_tecnica','tecnica')</onclick>
						</field>
					</row>
				</fieldset>
				<fieldset global="id" ifeval="CONFIG('tab_info_adicional_presupuesto')&gt;1 &amp;&amp; execute_query('SELECT LENGTH(extras) hasdata FROM tbl_presupuestos WHERE id='.abs($id)) || ($id>=0)">
					<title lang="true">extras</title>
					<icon eval="true">ICON("form")</icon>
					<row>
						<field>
							<name>extras</name>
							<label lang="true">extras</label>
							<type>textarea</type>
							<width>600px</width>
							<height>240px</height>
							<colspan>4</colspan>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
						</field>
					</row>
					<row global="id" ifeval="$id&gt;=0">
						<field ifeval="!ismobile()">
							<name>textos_extras</name>
							<label lang="true">textos</label>
							<type>select</type>
							<width>240px</width>
							<query include="xml/common/qtextos.xml" replace="true"/>
							<value></value>
						</field>
						<field>
							<type>button</type>
							<value lang="true">textos_add</value>
							<icon>fa fa-plus-circle</icon>
							<onclick>add_textos_textarea('textos_extras','extras')</onclick>
						</field>
					</row>
				</fieldset>
			</detalle>
			<tareas_head global="id" ifeval="CONFIG('tab_tareas_presupuesto')&gt;1">
				<fieldset>
					<title lang="true">tareaspresupuesto</title>
					<icon eval="true">ICON("form")</icon>
					<width>700px</width>
					<head>
						<field>
							<type>separator</type>
							<class>thead</class>
						</field>
						<field>
							<type>label</type>
							<label lang="true">horastotal</label>
							<class>center bold thead</class>
						</field>
						<field>
							<type>label</type>
							<label eval="true">LANG("preciomedio")." (".CONFIG("accounting_currency").")"</label>
							<class>center bold thead</class>
						</field>
						<field>
							<type>label</type>
							<label eval="true">LANG("preciototal")." (".CONFIG("accounting_currency").")"</label>
							<class>center bold thead</class>
						</field>
					</head>
					<head>
						<field>
							<type>label</type>
							<label lang="true">presupuesto</label>
							<class>center bold thead</class>
						</field>
						<field>
							<name>horastotal</name>
							<type>text</type>
							<readonly>true</readonly>
							<class>tbody</class>
							<width>120px</width>
						</field>
						<field>
							<name>preciomedio</name>
							<type>text</type>
							<readonly>true</readonly>
							<class>tbody</class>
							<width>120px</width>
						</field>
						<field>
							<name>preciototal</name>
							<type>text</type>
							<readonly>true</readonly>
							<class>tbody</class>
							<width>120px</width>
						</field>
					</head>
				</fieldset>
			</tareas_head>
			<tareas_old global="id" ifeval="CONFIG('tab_tareas_presupuesto')&gt;1">
				<fieldset>
					<width>700px</width>
					<head>
						<field global="id" ifeval="$id&lt;0">
							<type>checkbox</type>
							<class3>master</class3>
							<class2>thead</class2>
							<width>1px</width>
							<value>1</value>
						</field>
						<field>
							<type>label</type>
							<label lang="true">desctareas</label>
							<class>center bold thead</class>
						</field>
						<field>
							<type>label</type>
							<label lang="true">horas</label>
							<class>center bold thead</class>
						</field>
						<field>
							<type>label</type>
							<label eval="true">LANG("prun")." (".CONFIG("accounting_currency").")"</label>
							<class>center bold thead</class>
						</field>
						<field>
							<type>label</type>
							<label eval="true">LANG("dto")." (%)"</label>
							<class>center bold thead</class>
						</field>
						<field>
							<type>label</type>
							<label eval="true">LANG("total")." (".CONFIG("accounting_currency").")"</label>
							<class>center bold thead</class>
						</field>
						<field global="id" ifeval="$id&gt;=0">
							<type>separator</type>
							<class>thead</class>
							<colspan>100</colspan>
						</field>
					</head>
					<row>
						<field>
							<name>id</name>
							<type>hidden</type>
						</field>
						<field>
							<name>id_presupuesto</name>
							<type>hidden</type>
						</field>
						<field global="id" ifeval="$id&lt;0">
							<type>checkbox</type>
							<name>liquidar</name>
							<value>1</value>
							<class3>slave</class3>
							<class2>tbody</class2>
							<width>1px</width>
						</field>
						<field>
							<name>tarea</name>
							<type>text</type>
							<width>400px</width>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<class>tbody</class>
							<speech>true</speech>
						</field>
						<field>
							<name>horas</name>
							<type>float</type>
							<width>60px</width>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<onchange>update_totales_proyecto()</onchange>
							<class>tbody</class>
						</field>
						<field>
							<name>precio</name>
							<type>float</type>
							<width>60px</width>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<onchange>update_totales_proyecto()</onchange>
							<class>tbody</class>
						</field>
						<field>
							<name>descuento</name>
							<type>float</type>
							<width>60px</width>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<onchange>update_totales_proyecto()</onchange>
							<class>tbody</class>
						</field>
						<field>
							<name>total2</name>
							<type>text</type>
							<width>60px</width>
							<readonly>true</readonly>
							<class>tbody</class>
						</field>
						<field global="id" ifeval="$id&gt;=0">
							<name>delete</name>
							<type>checkbox</type>
							<label lang="true">delete</label>
							<value>1</value>
							<onchange>update_totales_proyecto()</onchange>
							<width>1px</width>
							<width2>1px</width2>
							<icon>fa fa-trash</icon>
							<class>tbody</class>
							<class2>tbody</class2>
						</field>
					</row>
				</fieldset>
			</tareas_old>
			<tareas_new global="id" ifeval="CONFIG('tab_tareas_presupuesto')&gt;1">
				<fieldset>
					<width>700px</width>
					<head>
						<field>
							<type>label</type>
							<label lang="true">desctareas</label>
							<class>center bold thead</class>
						</field>
						<field>
							<type>label</type>
							<label lang="true">horas</label>
							<class>center bold thead</class>
						</field>
						<field>
							<type>label</type>
							<label eval="true">LANG("prun")." (".CONFIG("accounting_currency").")"</label>
							<class>center bold thead</class>
						</field>
						<field>
							<type>label</type>
							<label eval="true">LANG("dto")." (%)"</label>
							<class>center bold thead</class>
						</field>
						<field>
							<type>label</type>
							<label eval="true">LANG("total")." (".CONFIG("accounting_currency").")"</label>
							<class>center bold thead</class>
						</field>
					</head>
					<row>
						<class>none</class>
						<field>
							<name>id</name>
							<type>hidden</type>
						</field>
						<field>
							<name>id_presupuesto</name>
							<type>hidden</type>
						</field>
						<field>
							<name>tarea</name>
							<type>text</type>
							<width>400px</width>
							<class>tbody</class>
							<speech>true</speech>
						</field>
						<field>
							<name>horas</name>
							<type>float</type>
							<width>60px</width>
							<onchange>update_totales_proyecto()</onchange>
							<class>tbody</class>
						</field>
						<field>
							<name>precio</name>
							<type>float</type>
							<width>60px</width>
							<onchange>update_totales_proyecto()</onchange>
							<class>tbody</class>
						</field>
						<field>
							<name>descuento</name>
							<type>float</type>
							<width>60px</width>
							<onchange>update_totales_proyecto()</onchange>
							<class>tbody</class>
						</field>
						<field>
							<name>total2</name>
							<type>text</type>
							<width>60px</width>
							<readonly>true</readonly>
							<class>tbody</class>
						</field>
					</row>
					<tail>
						<field>
							<type>separator</type>
						</field>
					</tail>
					<tail>
						<field>
							<type>button</type>
							<value lang="true">addtarea</value>
							<class>left</class>
							<class2>init_additem</class2>
							<onclick>additem(this)</onclick>
							<icon>fa fa-plus-circle</icon>
						</field>
					</tail>
				</fieldset>
			</tareas_new>
			<products_head global="id" ifeval="CONFIG('tab_productos_presupuesto')&gt;1">
				<fieldset>
					<title lang="true">productospresupuesto</title>
					<icon eval="true">ICON("form")</icon>
					<width>700px</width>
					<head>
						<field>
							<type>separator</type>
							<class>thead</class>
						</field>
						<field>
							<type>label</type>
							<label lang="true">unidadestotal</label>
							<class>center bold thead</class>
						</field>
						<field>
							<type>label</type>
							<label eval="true">LANG("preciototal")." (".CONFIG("accounting_currency").")"</label>
							<class>center bold thead</class>
						</field>
					</head>
					<head>
						<field>
							<type>label</type>
							<label lang="true">presupuesto</label>
							<class>center bold thead</class>
						</field>
						<field>
							<name>unidadestotal</name>
							<type>text</type>
							<readonly>true</readonly>
							<class>tbody</class>
							<width>120px</width>
						</field>
						<field>
							<name>preciototal4</name>
							<type>text</type>
							<readonly>true</readonly>
							<class>tbody</class>
							<width>120px</width>
						</field>
					</head>
				</fieldset>
			</products_head>
			<products_old global="id" ifeval="CONFIG('tab_productos_presupuesto')&gt;1">
				<fieldset>
					<width>700px</width>
					<head>
						<field global="id" ifeval="$id&lt;0">
							<type>checkbox</type>
							<class3>master</class3>
							<class2>thead</class2>
							<width>1px</width>
							<value>1</value>
						</field>
						<field>
							<type>label</type>
							<label lang="true">descproductos</label>
							<class>center bold thead</class>
						</field>
						<field>
							<type>label</type>
							<label lang="true">unid</label>
							<class>center bold thead</class>
						</field>
						<field>
							<type>label</type>
							<label eval="true">LANG("prun")." (".CONFIG("accounting_currency").")"</label>
							<class>center bold thead</class>
						</field>
						<field>
							<type>label</type>
							<label eval="true">LANG("dto")." (%)"</label>
							<class>center bold thead</class>
						</field>
						<field>
							<type>label</type>
							<label eval="true">LANG("total")." (".CONFIG("accounting_currency").")"</label>
							<class>center bold thead</class>
						</field>
						<field global="id" ifeval="$id&gt;=0">
							<type>separator</type>
							<class>thead</class>
							<colspan>100</colspan>
						</field>
					</head>
					<row>
						<field>
							<name>id</name>
							<type>hidden</type>
						</field>
						<field>
							<name>id_presupuesto</name>
							<type>hidden</type>
						</field>
						<field global="id" ifeval="$id&lt;0">
							<type>checkbox</type>
							<name>liquidar</name>
							<value>1</value>
							<class3>slave</class3>
							<class2>tbody</class2>
							<width>1px</width>
						</field>
						<field>
							<name>id_producto</name>
							<type>hidden</type>
						</field>
						<field>
							<name>concepto</name>
							<type>text</type>
							<width>400px</width>
							<class>tbody</class>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
							<autocomplete>true</autocomplete>
							<querycomplete>productos</querycomplete>
							<oncomplete>
								$("#"+prefix+"id_producto").val(ui.item.id);
								$("#"+prefix+"precio").val(ui.item.precio);
								$("#"+prefix+"descuento").val(ui.item.descuento);
								update_totales_proyecto();
							</oncomplete>
						</field>
						<field>
							<name>unidades</name>
							<type>float</type>
							<width>60px</width>
							<onchange>update_totales_proyecto()</onchange>
							<class>tbody</class>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
						</field>
						<field>
							<name>precio</name>
							<type>float</type>
							<width>60px</width>
							<onchange>update_totales_proyecto()</onchange>
							<class>tbody</class>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
						</field>
						<field>
							<name>descuento</name>
							<type>float</type>
							<width>60px</width>
							<onchange>update_totales_proyecto()</onchange>
							<class>tbody</class>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
						</field>
						<field>
							<name>total2</name>
							<type>text</type>
							<width>60px</width>
							<readonly>true</readonly>
							<class>tbody</class>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
						</field>
						<field global="id" ifeval="$id&gt;=0">
							<name>delete</name>
							<type>checkbox</type>
							<label lang="true">delete</label>
							<value>1</value>
							<onchange>update_totales_proyecto()</onchange>
							<width>1px</width>
							<width2>1px</width2>
							<icon>fa fa-trash</icon>
							<class>tbody</class>
							<class2>tbody</class2>
						</field>
					</row>
				</fieldset>
			</products_old>
			<products_new global="id" ifeval="CONFIG('tab_productos_presupuesto')&gt;1">
				<fieldset>
					<width>700px</width>
					<head>
						<field>
							<type>label</type>
							<label lang="true">descproductos</label>
							<class>center bold thead</class>
						</field>
						<field>
							<type>label</type>
							<label lang="true">unid</label>
							<class>center bold thead</class>
						</field>
						<field>
							<type>label</type>
							<label eval="true">LANG("prun")." (".CONFIG("accounting_currency").")"</label>
							<class>center bold thead</class>
						</field>
						<field>
							<type>label</type>
							<label eval="true">LANG("dto")." (%)"</label>
							<class>center bold thead</class>
						</field>
						<field>
							<type>label</type>
							<label eval="true">LANG("total")." (".CONFIG("accounting_currency").")"</label>
							<class>center bold thead</class>
						</field>
					</head>
					<row>
						<class>none</class>
						<field>
							<name>id</name>
							<type>hidden</type>
						</field>
						<field>
							<name>id_presupuesto</name>
							<type>hidden</type>
						</field>
						<field>
							<name>id_producto</name>
							<type>hidden</type>
						</field>
						<field>
							<name>concepto</name>
							<type>text</type>
							<width>400px</width>
							<class>tbody</class>
							<autocomplete>true</autocomplete>
							<querycomplete>productos</querycomplete>
							<oncomplete>
								$("#"+prefix+"id_producto").val(ui.item.id);
								$("#"+prefix+"precio").val(ui.item.precio);
								$("#"+prefix+"descuento").val(ui.item.descuento);
								update_totales_proyecto();
							</oncomplete>
						</field>
						<field>
							<name>unidades</name>
							<type>float</type>
							<width>60px</width>
							<onchange>update_totales_proyecto()</onchange>
							<class>tbody</class>
						</field>
						<field>
							<name>precio</name>
							<type>float</type>
							<width>60px</width>
							<onchange>update_totales_proyecto()</onchange>
							<class>tbody</class>
						</field>
						<field>
							<name>descuento</name>
							<type>float</type>
							<width>60px</width>
							<onchange>update_totales_proyecto()</onchange>
							<class>tbody</class>
						</field>
						<field>
							<name>total2</name>
							<type>text</type>
							<width>60px</width>
							<readonly>true</readonly>
							<class>tbody</class>
						</field>
					</row>
					<tail>
						<field>
							<type>separator</type>
						</field>
					</tail>
					<tail>
						<field>
							<type>button</type>
							<value lang="true">addproduct</value>
							<class>left</class>
							<class2>init_additem</class2>
							<onclick>additem(this)</onclick>
							<icon>fa fa-plus-circle</icon>
						</field>
					</tail>
				</fieldset>
			</products_new>
			<condiciones>
				<fieldset global="id" ifeval="CONFIG('tab_condiciones_presupuesto')&gt;1 &amp;&amp; execute_query('SELECT LENGTH(condiciones) hasdata FROM tbl_presupuestos WHERE id='.abs($id)) || ($id&gt;=0)" >
					<title lang="true">condiciones</title>
					<icon eval="true">ICON("form")</icon>
					<row>
						<field>
							<name>id</name>
							<type>hidden</type>
						</field>
						<field>
							<name>condiciones</name>
							<label lang="true">condiciones</label>
							<type>textarea</type>
							<width>600px</width>
							<height>240px</height>
							<colspan>4</colspan>
							<readonly global="id" eval="true">$id>=0?"false":"true"</readonly>
						</field>
					</row>
					<row global="id" ifeval="$id&gt;=0">
						<field ifeval="!ismobile()">
							<name>textos_condiciones</name>
							<label lang="true">textos</label>
							<type>select</type>
							<width>240px</width>
							<query include="xml/common/qtextos.xml" replace="true"/>
							<value></value>
						</field>
						<field>
							<type>button</type>
							<value lang="true">textos_add</value>
							<icon>fa fa-plus-circle</icon>
							<onclick>add_textos_textarea('textos_condiciones','condiciones')</onclick>
						</field>
					</row>
				</fieldset>
			</condiciones>
			<comments_old include="xml/common/commentsold.xml"/>
			<files_old include="xml/common/filesold.xml" />
			<comments_new include="xml/common/commentnew.xml"/>
			<files_new include="xml/common/filesnew.xml"/>
			<agenda include="xml/common/relatedagenda.xml" replace="true" />
			<actas include="xml/common/relatedactas.xml" replace="true" />
			<control include="xml/common/control.xml" />
			<folders include="xml/common/folders.xml" />
		</fields>
		<quick include="xml/common/quickform.xml" />
		<buttons include="xml/common/buttonsform.xml" />
		<node path="buttons/row/field" before="true">
			<field global="id" ifeval="$id&lt;0">
				<type>button</type>
				<value eval="true">LANG("crearproyecto")</value>
				<onclick>migrar()</onclick>
				<disabled eval="true">check_user("proyectos","create")?"false":"true"</disabled>
				<class>nowrap contextmenu</class>
				<icon>fa fa-plus-circle</icon>
			</field>
			<field global="id" ifeval="$id&lt;0">
				<type>button</type>
				<value eval="true">LANG("actionfacturar")</value>
				<tip eval="true">LANG("actionfacturar")</tip>
				<onclick>facturar()</onclick>
				<disabled eval="true">check_user("facturas","create")?"false":"true"</disabled>
				<class>nowrap contextmenu</class>
				<icon>fa fa-plus-circle</icon>
			</field>
		</node>
		<javascript>
			<javascript include="xml/common/jsform.xml" replace="true"/>
			<cache>
				<include>js/proyectos.js</include>
				<include>js/updateproyectos.js</include>
				<include>js/addtextos.js</include>
			</cache>
			<function eval="true">"migrar() { dialog(\"".LANG_ESCAPE("confirm")."\",\"".LANG_ESCAPE("msgcrear")."\",{'".LANG_ESCAPE("yes")."':function() { dialog('close'); setParam('action','migrar'); submit1(); },'".LANG_ESCAPE("no")."':function() { dialog('close'); } }); }"</function>
			<function eval="true">"facturar() { dialog(\"".LANG_ESCAPE("confirm")."\",\"".LANG_ESCAPE("msgfacturar")."\",{'".LANG_ESCAPE("yes")."':function() { dialog('close'); setParam('action','liquidar'); submit1(); },'".LANG_ESCAPE("no")."':function() { dialog('close'); } }); }"</function>
		</javascript>
	</form>
	<insert>
		<query include="xml/common/qpermcreate.xml" replace="true"/>
		<query include="xml/common/autonombre.xml" replace="true"/>
		<query match="default" prefix="true" global="page" preeval="true" eval="true">preeval_insert_query(page2table($page))</query>
        <query include="xml/common/qcontrolinsert.xml" replace="true"/>
		<query match="detalle" prefix="true" global="page" eval="true">setParam("id",execute_query("SELECT MAX(id) FROM ".page2table($page)))</query>
		<query match="detalle" prefix="true" eval="true">make_update_query("tbl_presupuestos",array(
			"objetivos"=>getParam("objetivos"),
			"funcional"=>getParam("funcional"),
			"tecnica"=>getParam("tecnica"),
			"extras"=>getParam("extras")
		),make_where_query(array(
			"id"=>intval(getParam("id"))
		)))</query>
		<query match="condiciones" prefix="true" eval="true">setParam("id",execute_query("SELECT MAX(id) FROM ".page2table(getParamWithoutPrefix("page"))))</query>
		<query match="condiciones" prefix="true" eval="true">make_update_query("tbl_presupuestos",array(
			"condiciones"=>getParam("condiciones")
		),make_where_query(array(
			"id"=>intval(getParam("id"))
		)))</query>
		<query match="tareas_new" prefix="true" eval="true">getParam("tarea")?make_insert_query("tbl_presupuestos_t",array(
			"tarea"=>getParam("tarea"),
			"horas"=>getParam("horas"),
			"precio"=>getParam("precio"),
			"descuento"=>getParam("descuento")
		),array(
			"id_presupuesto"=>"SELECT MAX(id) FROM tbl_presupuestos"
		)):""</query>
		<query match="products_new" prefix="true" eval="true">getParam("id_producto")?make_insert_query("tbl_presupuestos_p",array(
			"id_producto"=>intval(getParam("id_producto")),
			"concepto"=>getParam("concepto"),
			"unidades"=>getParam("unidades"),
			"precio"=>getParam("precio"),
			"descuento"=>getParam("descuento")
		),array(
			"id_presupuesto"=>"SELECT MAX(id) FROM tbl_presupuestos"
		)):""</query>
		<query include="xml/common/qfilesinsert.xml" replace="true"/>
		<query include="xml/common/qfoldersinsert.xml" replace="true"/>
	</insert>
	<update>
		<query include="xml/common/qpermupdate.xml" replace="true"/>
		<query match="default" prefix="true" global="page" preeval="true" eval="true">preeval_update_query(page2table($page))</query>
        <query include="xml/common/qcontrolupdate.xml" replace="true"/>
		<query match="detalle" prefix="true" eval="true">make_update_query("tbl_presupuestos",array(
			"objetivos"=>getParam("objetivos"),
			"funcional"=>getParam("funcional"),
			"tecnica"=>getParam("tecnica"),
			"extras"=>getParam("extras")
		),make_where_query(array(
			"id"=>intval(getParam("id"))
		)))</query>
		<query match="condiciones" prefix="true" eval="true">make_update_query("tbl_presupuestos",array(
			"condiciones"=>getParam("condiciones")
		),make_where_query(array(
			"id"=>intval(getParam("id"))
		)))</query>
		<query match="tareas_old" prefix="true" eval="true">make_update_query("tbl_presupuestos_t",array(
			"tarea"=>getParam("tarea"),
			"horas"=>getParam("horas"),
			"precio"=>getParam("precio"),
			"descuento"=>getParam("descuento")
		),make_where_query(array(
			"id"=>intval(getParam("id"))
		)))</query>
		<query match="tareas_old" prefix="true" eval="true">getParam("delete")?make_delete_query("tbl_presupuestos_t",make_where_query(array("id"=>intval(getParam("id"))))):""</query>
		<query match="tareas_new" prefix="true" eval="true">getParam("tarea")?make_insert_query("tbl_presupuestos_t",array(
			"id_presupuesto"=>intval(getParam("id_presupuesto")),
			"tarea"=>getParam("tarea"),
			"horas"=>getParam("horas"),
			"precio"=>getParam("precio"),
			"descuento"=>getParam("descuento")
		)):""</query>
		<query match="products_old" prefix="true" eval="true">make_update_query("tbl_presupuestos_p",array(
			"id_producto"=>intval(getParam("id_producto")),
			"concepto"=>getParam("concepto"),
			"unidades"=>getParam("unidades"),
			"precio"=>getParam("precio"),
			"descuento"=>getParam("descuento")
		),make_where_query(array(
			"id"=>intval(getParam("id"))
		)))</query>
		<query match="products_old" prefix="true" eval="true">getParam("delete")?make_delete_query("tbl_presupuestos_p",make_where_query(array("id"=>intval(getParam("id"))))):""</query>
		<query match="products_new" prefix="true" eval="true">getParam("id_producto")?make_insert_query("tbl_presupuestos_p",array(
			"id_presupuesto"=>intval(getParam("id_presupuesto")),
			"id_producto"=>intval(getParam("id_producto")),
			"concepto"=>getParam("concepto"),
			"unidades"=>getParam("unidades"),
			"precio"=>getParam("precio"),
			"descuento"=>getParam("descuento")
		)):""</query>
		<query include="xml/common/qfilesdelete.xml" replace="true" />
		<query include="xml/common/qfilesupdate.xml" replace="true"/>
		<query include="xml/common/qcommentsdelete.xml" replace="true" />
		<query include="xml/common/qcommentsinsert.xml" replace="true" />
		<query include="xml/common/qfoldersupdate.xml" replace="true"/>
	</update>
	<delete>
		<query include="xml/common/qpermdelete.xml" replace="true"/>
		<query include="xml/common/qdelete.xml" replace="true" />
		<query eval="true">make_delete_query("tbl_presupuestos_t",make_where_query(array("id_presupuesto"=>abs(getParam("id")))))</query>
		<query eval="true">make_delete_query("tbl_presupuestos_p",make_where_query(array("id_presupuesto"=>abs(getParam("id")))))</query>
		<query include="xml/common/qdeletecomments.xml" replace="true" />
		<query include="xml/common/qdeletefiles.xml" replace="true" />
		<query include="xml/common/qcontroldelete.xml" replace="true"/>
		<query include="xml/common/qfoldersdelete.xml" replace="true"/>
	</delete>
	<pdf>
		<constructor>"P","mm","A4"</constructor>
		<margins>50,30,30,30</margins>
		<query>"SELECT * FROM (
			SELECT LPAD(a.id,".intval(CONFIG("zero_padding_digits")).",0) id,
				".make_extra_query_with_login("d.")." usuario,
				e.datetime datetime,
				CASE
					WHEN a.id_cliente!='0' THEN b1.nombre
					WHEN a.id_posiblecli!='0' THEN b2.nombre
					ELSE '".LANG_ESCAPE("sincliente")."'
				END cliente,
				CASE
					WHEN a.id_cliente!='0' THEN b1.nombre
					WHEN a.id_posiblecli!='0' THEN b2.nombre
					ELSE '".LANG_ESCAPE("sincliente")."'
				END cliente2,
				CASE
					WHEN a.id_cliente!='0' THEN b1.cif
					WHEN a.id_posiblecli!='0' THEN b2.cif
					ELSE ''
				END cif,
				a.nombre nombre,
				a.nombre nombre2,
				a.fecha fecha,
				(SELECT ROUND(SUM(precio*horas*(100.0-descuento)/100.0),2) FROM tbl_presupuestos_t WHERE id_presupuesto=a.id) total1,
				(SELECT ROUND(SUM(precio*unidades*(100.0-descuento)/100.0),2) FROM tbl_presupuestos_p WHERE id_presupuesto=a.id) total2,
				CASE a.id_estado WHEN '0' THEN '".LANG_ESCAPE("sinestado")."' ELSE c.nombre END estado,
				(SELECT COUNT(*) FROM tbl_presupuestos_t WHERE id_presupuesto=a.id) tareas,
				(SELECT COUNT(*) FROM tbl_presupuestos_p WHERE id_presupuesto=a.id) productos,
				a.descripcion descripcion,a.id_campanya id_campanya,
				a.objetivos objetivos,a.funcional funcional,a.tecnica tecnica,a.extras extras,a.condiciones condiciones,
				id_usuario,a.id_estado,a.id_cliente id_cliente,a.id_posiblecli id_posiblecli,d.id_grupo id_grupo,c.activo activo
			FROM tbl_presupuestos a
			LEFT JOIN tbl_clientes b1 ON b1.id=a.id_cliente
			LEFT JOIN tbl_posiblescli b2 ON b2.id=a.id_posiblecli
			LEFT JOIN tbl_estados c ON a.id_estado=c.id
			LEFT JOIN tbl_registros e ON e.id_aplicacion='".page2id(getParam("page"))."' AND e.id_registro=a.id AND e.first=1
			LEFT JOIN tbl_usuarios d ON e.id_usuario=d.id
			) z WHERE ROUND(id) IN (".check_ids(getParam("id")).")"</query>
		<foreach>
			<!-- TEMPLATE -->
			<header>
				<!-- LOGO -->
				<margins>0,0,0,0</margins>
				<image>CONFIG("logo_left"),CONFIG("logo_top"),CONFIG("logo_width"),CONFIG("logo_height"),get_directory("dirs/filesdir").CONFIG("logo_file")</image>
				<!-- PONER MARCA DE AGUA -->
				<font>"normal","B",CONFIG("water_presupuestos_size"),"#eeeeee"</font>
				<text>CONFIG("water_presupuestos_posx"),CONFIG("water_presupuestos_posy"),CONFIG("water_presupuestos_text"),CONFIG("water_presupuestos_angle")</text>
				<margins>50,30,30,30</margins>
				<setxy>30,50</setxy>
			</header>
			<footer>
				<margins>0,0,0,0</margins>
				<!-- PONER PIE DE PAGINA -->
				<font>"normal","",6,CONFIG("color_text2")</font>
				<pageno>30,279,150,0,"R",LANG("paginaspc"),LANG("spcdespc")</pageno>
				<margins>50,30,30,30</margins>
			</footer>
			<!-- BEGIN -->
			<newpage></newpage>
			<color>CONFIG("color_line"),"#000000"</color>
			<!-- DATOS PRESUPUESTO -->
			<setxy>30,50</setxy>
			<getxy>"x","y"</getxy>
			<font>"normal","B",8,CONFIG("color_text1")</font>
			<textarea>30,$row["y"],25,4,"R",LANG("presupuesto")</textarea>
			<font>"normal","",8,CONFIG("color_text2")</font>
			<textarea>55,$row["y"],75,4,"L",$row["id"]</textarea>
			<font>"normal","B",8,CONFIG("color_text1")</font>
			<textarea>105,$row["y"],25,4,"R",LANG("date")</textarea>
			<font>"normal","",8,CONFIG("color_text2")</font>
			<textarea>130,$row["y"],75,4,"L",$row["fecha"]</textarea>
			<getxy>"x","y"</getxy>
			<setxy>$row["x"],$row["y"]+2</setxy>
			<getxy>"x","y"</getxy>
			<line>30,$row["y"],180,$row["y"]</line>
			<getxy>"x","y"</getxy>
			<setxy>$row["x"],$row["y"]+2</setxy>
			<getxy>"x","y"</getxy>
			<font>"normal","B",8,CONFIG("color_text1")</font>
			<textarea>30,$row["y"],25,4,"R",LANG("cliente")</textarea>
			<font>"normal","",8,CONFIG("color_text2")</font>
			<textarea>55,$row["y"],75,4,"L",$row["cliente"]</textarea>
			<font>"normal","B",8,CONFIG("color_text1")</font>
			<textarea>105,$row["y"],25,4,"R",LANG("cif")</textarea>
			<font>"normal","",8,CONFIG("color_text2")</font>
			<textarea>130,$row["y"],75,4,"L",$row["cif"]</textarea>
			<getxy>"x","y"</getxy>
			<setxy>$row["x"],$row["y"]+2</setxy>
			<getxy>"x","y"</getxy>
			<line>30,$row["y"],180,$row["y"]</line>
			<getxy>"x","y"</getxy>
			<setxy>$row["x"],$row["y"]+2</setxy>
			<getxy>"x","y"</getxy>
			<font>"normal","B",8,CONFIG("color_text1")</font>
			<textarea>30,$row["y"],25,4,"R",LANG("proyecto")</textarea>
			<font>"normal","",8,CONFIG("color_text2")</font>
			<textarea>55,$row["y"],125,4,"L",$row["nombre"]</textarea>
			<eval>$row["objetivos"]</eval>
				<!-- OBJETIVOS -->
				<getxy>"x","y"</getxy>
				<setxy>$row["x"],$row["y"]+2</setxy>
				<getxy>"x","y"</getxy>
				<line>30,$row["y"],180,$row["y"]</line>
				<getxy>"x","y"</getxy>
				<setxy>$row["x"],$row["y"]+2</setxy>
				<getxy>"x","y"</getxy>
				<checky>8</checky>
				<getxy>"x","y"</getxy>
				<font>"normal","B",8,CONFIG("color_text1")</font>
				<textarea>30,$row["y"],25,4,"R",LANG("objetivos")</textarea>
				<font>"normal","",8,CONFIG("color_text2")</font>
				<textarea>55,$row["y"],125,4,"L",trim($row["objetivos"])</textarea>
				<!-- CORRECCION DE ERROR -->
				<getxy>"x","y2"</getxy>
			<eval>$row["objetivos"] &amp;&amp; $row["y2"]-$row["y"]==4</eval>
				<textarea>55,$row["y2"],125,4,"L",""</textarea>
			<eval>$row["funcional"]</eval>
				<!-- PROPUESTA FUNCIONAL -->
				<getxy>"x","y"</getxy>
				<setxy>$row["x"],$row["y"]+2</setxy>
				<getxy>"x","y"</getxy>
				<line>30,$row["y"],180,$row["y"]</line>
				<getxy>"x","y"</getxy>
				<setxy>$row["x"],$row["y"]+2</setxy>
				<getxy>"x","y"</getxy>
				<checky>8</checky>
				<getxy>"x","y"</getxy>
				<font>"normal","B",8,CONFIG("color_text1")</font>
				<textarea>30,$row["y"],25,4,"R",LANG("funcional")</textarea>
				<font>"normal","",8,CONFIG("color_text2")</font>
				<textarea>55,$row["y"],125,4,"L",trim($row["funcional"])</textarea>
				<!-- CORRECCION DE ERROR -->
				<getxy>"x","y2"</getxy>
			<eval>$row["funcional"] &amp;&amp; $row["y2"]-$row["y"]==4</eval>
				<textarea>55,$row["y2"],125,4,"L",""</textarea>
			<eval>$row["tecnica"]</eval>
				<!-- PROPUESTA TECNICA -->
				<getxy>"x","y"</getxy>
				<setxy>$row["x"],$row["y"]+2</setxy>
				<getxy>"x","y"</getxy>
				<line>30,$row["y"],180,$row["y"]</line>
				<getxy>"x","y"</getxy>
				<setxy>$row["x"],$row["y"]+2</setxy>
				<getxy>"x","y"</getxy>
				<checky>8</checky>
				<getxy>"x","y"</getxy>
				<font>"normal","B",8,CONFIG("color_text1")</font>
				<textarea>30,$row["y"],25,4,"R",LANG("tecnica")</textarea>
				<font>"normal","",8,CONFIG("color_text2")</font>
				<textarea>55,$row["y"],125,4,"L",trim($row["tecnica"])</textarea>
				<!-- CORRECCION DE ERROR -->
				<getxy>"x","y2"</getxy>
			<eval>$row["tecnica"] &amp;&amp; $row["y2"]-$row["y"]==4</eval>
				<textarea>55,$row["y2"],125,4,"L",""</textarea>
			<eval>$row["extras"]</eval>
				<!-- EXTRAS -->
				<getxy>"x","y"</getxy>
				<setxy>$row["x"],$row["y"]+2</setxy>
				<getxy>"x","y"</getxy>
				<line>30,$row["y"],180,$row["y"]</line>
				<getxy>"x","y"</getxy>
				<setxy>$row["x"],$row["y"]+2</setxy>
				<getxy>"x","y"</getxy>
				<checky>8</checky>
				<getxy>"x","y"</getxy>
				<font>"normal","B",8,CONFIG("color_text1")</font>
				<textarea>30,$row["y"],25,4,"R",LANG("extras")</textarea>
				<font>"normal","",8,CONFIG("color_text2")</font>
				<textarea>55,$row["y"],125,4,"L",trim($row["extras"])</textarea>
				<!-- CORRECCION DE ERROR -->
				<getxy>"x","y2"</getxy>
			<eval>$row["extras"] &amp;&amp; $row["y2"]-$row["y"]==4</eval>
				<textarea>55,$row["y2"],125,4,"L",""</textarea>
			<eval>$row["tareas"] || $row["productos"]</eval>
				<!-- VALORACION ECONÃMICA -->
				<getxy>"x","y"</getxy>
				<setxy>$row["x"],$row["y"]+2</setxy>
				<getxy>"x","y"</getxy>
				<line>30,$row["y"],180,$row["y"]</line>
				<getxy>"x","y"</getxy>
				<setxy>$row["x"],$row["y"]+2</setxy>
				<getxy>"x","y"</getxy>
				<checky>8</checky>
				<getxy>"x","y"</getxy>
				<font>"normal","B",8,CONFIG("color_text1")</font>
				<textarea>30,$row["y"],25,4,"R",LANG("valoracion")</textarea>
			<eval>$row["productos"]</eval>
				<!-- PRODUCTOS -->
				<font>"normal","",8,CONFIG("color_text2")</font>
				<textarea>55,$row["y"],25,4,"L",LANG("productos").":"</textarea>
				<getxy>"x","y"</getxy>
				<font>"normal","",8,CONFIG("color_text2")</font>
				<query>"SELECT *,ROUND(unidades*precio*(100.0-descuento)/100.0,2) total2,concepto producto FROM tbl_presupuestos_p a WHERE id_presupuesto='".intval($row["id"])."'"</query>
				<foreach>
					<getxy>"x","y"</getxy>
					<textarea>55,$row["y"],125,4,"L","- ".$row["producto"]." (".$row["unidades"]." ".mb_strtolower(LANG("unid"),"UTF-8").($row["descuento"]!=0?", ".$row["descuento"]."% ".mb_strtolower(LANG("dto"),"UTF-8"):"")."): ".$row["total2"].CONFIG("accounting_currency")</textarea>
				</foreach>
			<eval>$row["tareas"] &amp;&amp; $row["productos"]</eval>
				<!-- SEPARADOR -->
				<getxy>"x","y"</getxy>
				<setxy>$row["x"],$row["y"]+2</setxy>
				<getxy>"x","y"</getxy>
				<line>55,$row["y"],180,$row["y"]</line>
				<getxy>"x","y"</getxy>
				<setxy>$row["x"],$row["y"]+2</setxy>
				<getxy>"x","y"</getxy>
			<eval>$row["tareas"]</eval>
				<!-- TAREAS -->
				<font>"normal","",8,CONFIG("color_text2")</font>
				<textarea>55,$row["y"],25,4,"L",LANG("tareas").":"</textarea>
				<getxy>"x","y"</getxy>
				<font>"normal","",8,CONFIG("color_text2")</font>
				<query>"SELECT *,ROUND(horas*precio*(100.0-descuento)/100.0,2) total2 FROM tbl_presupuestos_t WHERE id_presupuesto='".intval($row["id"])."'"</query>
				<foreach>
					<getxy>"x","y"</getxy>
					<textarea>55,$row["y"],125,4,"L","- ".$row["tarea"]." (".$row["horas"]." ".mb_strtolower($row["horas"]==1?LANG("hora"):LANG("horas"),"UTF-8").($row["descuento"]!=0?", ".$row["descuento"]."% ".mb_strtolower(LANG("dto"),"UTF-8"):"")."): ".$row["total2"].CONFIG("accounting_currency")</textarea>
				</foreach>
			<eval>$row["tareas"] || $row["productos"]</eval>
				<!-- TOTAL -->
				<getxy>"x","y"</getxy>
				<setxy>$row["x"],$row["y"]+2</setxy>
				<getxy>"x","y"</getxy>
				<line>55,$row["y"],180,$row["y"]</line>
				<getxy>"x","y"</getxy>
				<setxy>$row["x"],$row["y"]+2</setxy>
				<getxy>"x","y"</getxy>
				<font>"normal","B",8,CONFIG("color_text2")</font>
				<textarea>55,$row["y"],125,4,"L",LANG("preciototal").": ".($row["total1"]+$row["total2"]).CONFIG("accounting_currency")</textarea>
			<eval>$row["condiciones"]</eval>
				<!-- CONDICIONES DEL PRESUPUESTO -->
				<getxy>"x","y"</getxy>
				<setxy>$row["x"],$row["y"]+2</setxy>
				<getxy>"x","y"</getxy>
				<line>30,$row["y"],180,$row["y"]</line>
				<getxy>"x","y"</getxy>
				<setxy>$row["x"],$row["y"]+2</setxy>
				<getxy>"x","y"</getxy>
				<checky>8</checky>
				<getxy>"x","y"</getxy>
				<font>"normal","B",8,CONFIG("color_text1")</font>
				<textarea>30,$row["y"],25,4,"R",LANG("condiciones")</textarea>
				<font>"normal","",8,CONFIG("color_text2")</font>
				<textarea>55,$row["y"],125,4,"L",trim($row["condiciones"])</textarea>
			<eval>true</eval>
			<!-- FIN -->
		</foreach>
		<output>encode_bad_chars(str_replace(".","",strpos(check_ids(getParam("id")),",")===false?execute_query("
		SELECT CONCAT('".LANG_ESCAPE("presupuesto")."',' ',LPAD(id,".intval(CONFIG("zero_padding_digits")).",0),' ',nombre) subject
		FROM tbl_presupuestos WHERE id IN (".check_ids(getParam("id")).")"):LANG("presupuestos"))).".pdf"</output>
	</pdf>
</root>